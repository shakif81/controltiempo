<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Administrador de Tareas</title>
  <style>
    :root {
      --bg: #f5f6fa;
      --accent: #2ecc71;
      --danger: #e74c3c;
      --warning: #f39c12;
      --card: #fff;
      --muted: #e9ecef;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      padding: 20px;
      height: 100vh;
      overflow: hidden;
    }
    
    .container {
      max-width: 100%;
      height: 100%;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .nav-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    
    .btn-secondary {
      background: #3498db;
      color: white;
    }
    
    .nav-buttons button:hover {
      transform: translateY(-2px);
    }
    
    .form-section {
      background: var(--muted);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      flex: 1;
      overflow-y: auto;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #2f3640;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .array-item {
      background: white;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
    }
    
    .array-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .array-header h4 {
      margin: 0;
      color: #2f3640;
    }
    
    .btn-small {
      padding: 5px 10px;
      font-size: 0.8rem;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .btn-add {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .tareas-lista {
      margin-top: 20px;
      overflow-y: auto;
    }
    
    .tarea-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .tarea-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .tarea-nombre {
      font-weight: 600;
      color: #2f3640;
      font-size: 1.1rem;
    }
    
    .tarea-acciones {
      display: flex;
      gap: 8px;
    }
    
    .btn-edit {
      background: #3498db;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    
    .btn-delete {
      background: var(--danger);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    
    .tarea-detalles {
      color: #666;
      font-size: 0.9rem;
    }
    
    .tarea-tipo {
      display: inline-block;
      background: #3498db;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      margin-left: 10px;
    }
    
    .tarea-tipo.dc3 { background: #2ecc71; }
    .tarea-tipo.ms3 { background: #e74c3c; }
    .tarea-tipo.personalizada { background: #9b59b6; }
    
    .hidden {
      display: none;
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      display: none;
      z-index: 1000;
    }

    .material-cantidad-input {
      width: 80px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }

    .unidad-input {
      width: 100px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .critico-checkbox {
      width: auto;
      margin-right: 10px;
    }

    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    /* Estilos para carga de im√°genes */
    .image-upload-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .image-preview {
      max-width: 200px;
      max-height: 150px;
      border-radius: 6px;
      border: 1px solid #ddd;
      display: none;
    }

    .image-upload-button {
      display: inline-block;
      padding: 8px 15px;
      background: #3498db;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      font-size: 0.9rem;
    }

    .image-upload-button:hover {
      background: #2980b9;
    }

    .image-input-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .image-input-container input {
      flex: 1;
    }

    .image-upload-info {
      font-size: 0.8rem;
      color: #666;
      margin-top: 5px;
    }

    .file-input-hidden {
      display: none;
    }

    .nav-buttons-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .nav-buttons-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .btn-load-default {
      background: var(--warning);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- BOTONES ARRIBA SIN T√çTULO -->
    <div class="nav-buttons">
      <button class="btn-primary" onclick="mostrarSeccion('formulario')">‚ûï A√±adir Tarea</button>
      <button class="btn-secondary" onclick="mostrarSeccion('lista')">üìã Ver Tareas</button>
      <button class="btn-secondary" onclick="location.href='control-tiempo.html'">‚è± Ir a Control Tiempo</button>
      <button class="btn-load-default" onclick="cargarTareasPredeterminadas()">üîÑ Cargar Tareas Predeterminadas</button>
    </div>
    
    <!-- FORMULARIO -->
    <div id="formulario" class="form-section">
      <h3>üìù A√±adir/Editar Tarea</h3>
      
      <div class="form-group">
        <label for="tareaNombre">Nombre de la Tarea *</label>
        <input type="text" id="tareaNombre" placeholder="Ej: Bandeja AT Derecha">
      </div>
      
      <!-- FILA PARA TIPO Y TIEMPO -->
      <div class="nav-buttons-row">
        <div class="form-group">
          <label for="tareaTipo">Tipo de Tarea *</label>
          <select id="tareaTipo">
            <option value="">‚Äî Selecciona tipo ‚Äî</option>
            <option value="DC3">DC3</option>
            <option value="MS3">MS3</option>
            <option value="Personalizada">Personalizada</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="tareaTiempo">Tiempo Estimado (horas) *</label>
          <input type="number" id="tareaTiempo" step="0.01" min="0" placeholder="Ej: 1.27">
        </div>
      </div>
      
      <div class="form-group">
        <label for="tareaTitulo">T√≠tulo Descriptivo *</label>
        <input type="text" id="tareaTitulo" placeholder="Ej: Instalaci√≥n Completa">
      </div>

      <!-- SECCI√ìN DE ELEMENTOS CR√çTICOS -->
      <h4>‚ö†Ô∏è Elementos Cr√≠ticos</h4>
      <div id="criticosContainer"></div>
      <button type="button" class="btn-add" onclick="agregarCritico()">‚ûï A√±adir Elemento Cr√≠tico</button>

      <!-- SECCI√ìN DE MATERIALES -->
      <h4>üì¶ Materiales Necesarios</h4>
      <div id="materialesContainer"></div>
      <button type="button" class="btn-add" onclick="agregarMaterial()">‚ûï A√±adir Material</button>
      
      <!-- SECCI√ìN DE HERRAMIENTAS -->
      <h4>üõ†Ô∏è Herramientas</h4>
      <div id="herramientasContainer"></div>
      <button type="button" class="btn-add" onclick="agregarHerramienta()">‚ûï A√±adir Herramienta</button>
      
      <!-- SECCI√ìN DE PASOS -->
      <h4>üìã Pasos de Instalaci√≥n</h4>
      <div id="pasosContainer"></div>
      <button type="button" class="btn-add" onclick="agregarPaso()">‚ûï A√±adir Paso</button>
      
      <div style="margin-top: 20px; display: flex; gap: 10px;">
        <button class="btn-primary" onclick="guardarTarea()">üíæ Guardar Tarea</button>
        <button class="btn-small" onclick="limpiarFormulario()">üóëÔ∏è Limpiar</button>
      </div>
    </div>
    
    <!-- LISTA -->
    <div id="lista" class="form-section hidden">
      <h3>üìã Tareas Guardadas</h3>
      <div id="tareasLista" class="tareas-lista"></div>
    </div>
  </div>
  
  <div id="toast" class="toast"></div>

  <script>
    // VARIABLES GLOBALES - INICIALIZACI√ìN CORRECTA
    let tareasGuardadas = {};
    let tareaEditando = null;

    // INICIALIZACI√ìN AL CARGAR LA P√ÅGINA
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîÑ Inicializando aplicaci√≥n...');
      
      // Cargar tareas existentes
      const tareasStorage = localStorage.getItem('tareasInstrucciones');
      if (tareasStorage) {
        tareasGuardadas = JSON.parse(tareasStorage);
        console.log('üìÅ Tareas cargadas del localStorage:', Object.keys(tareasGuardadas));
      } else {
        console.log('üìÅ No hay tareas en localStorage, inicializando vac√≠o');
        tareasGuardadas = {};
      }
      
      mostrarTareas();
      
      // Inicializar formulario con elementos vac√≠os
      agregarCritico();
      agregarMaterial();
      agregarHerramienta();
      agregarPaso();
      
      console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
    });

    // TAREAS PREDETERMINADAS
    const tareasPredeterminadas = {
      "Bandeja AT Derecha": {
        tipo: "DC3",
        titulo: "Instalaci√≥n Bandeja AT Derecha",
        tiempo: 1.5,
        elementosCriticos: [
          {
            titulo: "TORNILLOS DE ANCLAJE",
            descripcion: "Verificar que los tornillos de anclaje sean de grado 8.8 o superior",
            critico: true
          }
        ],
        materiales: [
          {
            nombre: "Tornillos M8x40",
            descripcion: "Tornillos de fijaci√≥n grado 8.8",
            cantidad: 6,
            unidad: "unidades"
          }
        ],
        herramientas: [
          {
            nombre: "Llave torque 25Nm",
            descripcion: "Para apriete controlado de tornillos",
            imagen: ""
          }
        ],
        pasos: [
          {
            titulo: "Preparaci√≥n del √°rea",
            descripcion: "Limpiar y marcar la posici√≥n donde ir√° la bandeja",
            imagen: "",
            video: ""
          }
        ]
      }
    };

    function cargarTareasPredeterminadas() {
      console.log('üîÑ Cargando tareas predeterminadas...');
      
      // Combinar sin sobrescribir tareas existentes
      Object.keys(tareasPredeterminadas).forEach(nombre => {
        if (!tareasGuardadas[nombre]) {
          tareasGuardadas[nombre] = tareasPredeterminadas[nombre];
          console.log('‚úÖ Tarea predeterminada a√±adida:', nombre);
        }
      });
      
      // Guardar en localStorage
      localStorage.setItem('tareasInstrucciones', JSON.stringify(tareasGuardadas));
      
      // Actualizar tareasBase
      actualizarTodasTareasBase();
      
      mostrarTareas();
      mostrarToast('Tareas predeterminadas cargadas correctamente');
    }

    function actualizarTodasTareasBase() {
      let tareasBase = JSON.parse(localStorage.getItem('tareasBase') || '{}');
      
      Object.keys(tareasGuardadas).forEach(nombre => {
        tareasBase[nombre] = tareasGuardadas[nombre].tiempo;
      });
      
      localStorage.setItem('tareasBase', JSON.stringify(tareasBase));
      console.log('üìä Tareas base actualizadas:', tareasBase);
    }

    function mostrarSeccion(seccion) {
      document.getElementById('formulario').classList.add('hidden');
      document.getElementById('lista').classList.add('hidden');
      document.getElementById(seccion).classList.remove('hidden');
    }

    // FUNCIONES PARA A√ëADIR ELEMENTOS
    function agregarCritico() {
      const container = document.getElementById('criticosContainer');
      const id = 'critico-' + Date.now();
      
      const html = `
        <div class="array-item" id="${id}">
          <div class="array-header">
            <h4>Elemento Cr√≠tico</h4>
            <button type="button" class="btn-small" onclick="document.getElementById('${id}').remove()">‚ùå Eliminar</button>
          </div>
          <div class="form-group">
            <label>T√≠tulo del elemento cr√≠tico</label>
            <input type="text" placeholder="Ej: PASTA T√âRMICA NECESARIA">
          </div>
          <div class="form-group">
            <label>Descripci√≥n</label>
            <textarea placeholder="Describa por qu√© es cr√≠tico..."></textarea>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" class="critico-checkbox" checked>
              Marcar como cr√≠tico (mostrar√° alerta especial)
            </label>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
    }

    function agregarMaterial() {
      const container = document.getElementById('materialesContainer');
      const id = 'material-' + Date.now();
      
      const html = `
        <div class="array-item" id="${id}">
          <div class="array-header">
            <h4>Material</h4>
            <button type="button" class="btn-small" onclick="document.getElementById('${id}').remove()">‚ùå Eliminar</button>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Nombre del material</label>
              <input type="text" placeholder="Ej: Tornillos M6x20">
            </div>
            <div class="form-group">
              <label>Descripci√≥n</label>
              <input type="text" placeholder="Ej: Tornillos de fijaci√≥n">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Cantidad</label>
              <input type="number" class="material-cantidad-input" value="1" min="0">
            </div>
            <div class="form-group">
              <label>Unidad</label>
              <input type="text" class="unidad-input" placeholder="Ej: unidades" value="unidades">
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
    }

    function agregarHerramienta() {
      const container = document.getElementById('herramientasContainer');
      const id = 'herramienta-' + Date.now();
      const fileInputId = 'file-herramienta-' + Date.now();
      const previewId = 'preview-herramienta-' + Date.now();
      const urlInputId = 'url-herramienta-' + Date.now();
      
      const html = `
        <div class="array-item" id="${id}">
          <div class="array-header">
            <h4>Herramienta</h4>
            <button type="button" class="btn-small" onclick="document.getElementById('${id}').remove()">‚ùå Eliminar</button>
          </div>
          <div class="form-group">
            <label>Nombre de la herramienta</label>
            <input type="text" placeholder="Ej: Destornillador de estrella #2">
          </div>
          <div class="form-group">
            <label>Descripci√≥n (opcional)</label>
            <input type="text" placeholder="Ej: Para tornillos de fijaci√≥n">
          </div>
          <div class="form-group">
            <label>Imagen de la herramienta</label>
            <div class="image-upload-container">
              <div class="image-input-container">
                <input type="text" id="${urlInputId}" placeholder="URL de la imagen (opcional)">
                <label for="${fileInputId}" class="image-upload-button">üìÅ Cargar</label>
                <input type="file" id="${fileInputId}" class="file-input-hidden" accept="image/*" onchange="cargarImagenLocal('${fileInputId}', '${urlInputId}', '${previewId}')">
              </div>
              <img id="${previewId}" class="image-preview" src="" alt="Vista previa">
              <div class="image-upload-info">Puede usar una URL o cargar una imagen local</div>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
    }

    function agregarPaso() {
      const container = document.getElementById('pasosContainer');
      const id = 'paso-' + Date.now();
      const fileInputId = 'file-paso-' + Date.now();
      const previewId = 'preview-paso-' + Date.now();
      const urlInputId = 'url-paso-' + Date.now();
      
      const html = `
        <div class="array-item" id="${id}">
          <div class="array-header">
            <h4>Paso</h4>
            <button type="button" class="btn-small" onclick="document.getElementById('${id}').remove()">‚ùå Eliminar</button>
          </div>
          <div class="form-group">
            <label>T√≠tulo del paso</label>
            <input type="text" placeholder="Ej: Preparaci√≥n del √°rea">
          </div>
          <div class="form-group">
            <label>Descripci√≥n del paso</label>
            <textarea placeholder="Describa detalladamente este paso..."></textarea>
          </div>
          <div class="form-group">
            <label>Imagen del paso</label>
            <div class="image-upload-container">
              <div class="image-input-container">
                <input type="text" id="${urlInputId}" placeholder="URL de la imagen (opcional)">
                <label for="${fileInputId}" class="image-upload-button">üìÅ Cargar</label>
                <input type="file" id="${fileInputId}" class="file-input-hidden" accept="image/*" onchange="cargarImagenLocal('${fileInputId}', '${urlInputId}', '${previewId}')">
              </div>
              <img id="${previewId}" class="image-preview" src="" alt="Vista previa">
              <div class="image-upload-info">Puede usar una URL o cargar una imagen local</div>
            </div>
          </div>
          <div class="form-group">
            <label>URL del video (opcional)</label>
            <input type="text" placeholder="https://ejemplo.com/video-paso.mp4">
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
    }

    function cargarImagenLocal(fileInputId, urlInputId, previewId) {
      const fileInput = document.getElementById(fileInputId);
      const urlInput = document.getElementById(urlInputId);
      const preview = document.getElementById(previewId);
      
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          urlInput.value = e.target.result;
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    function limpiarFormulario() {
      document.getElementById('tareaNombre').value = '';
      document.getElementById('tareaTipo').value = '';
      document.getElementById('tareaTitulo').value = '';
      document.getElementById('tareaTiempo').value = '';
      document.getElementById('criticosContainer').innerHTML = '';
      document.getElementById('materialesContainer').innerHTML = '';
      document.getElementById('herramientasContainer').innerHTML = '';
      document.getElementById('pasosContainer').innerHTML = '';
      tareaEditando = null;
      
      agregarCritico();
      agregarMaterial();
      agregarHerramienta();
      agregarPaso();
      
      mostrarToast('Formulario limpiado');
    }

    // FUNCI√ìN GUARDAR TAREA
    function guardarTarea() {
      console.log('üîµ Bot√≥n Guardar Tarea pulsado');
      
      try {
        // Obtener valores b√°sicos
        const nombre = document.getElementById('tareaNombre').value.trim();
        const tipo = document.getElementById('tareaTipo').value;
        const titulo = document.getElementById('tareaTitulo').value.trim();
        const tiempoInput = document.getElementById('tareaTiempo').value;
        
        console.log('üìù Datos del formulario:', { nombre, tipo, titulo, tiempoInput });

        // Validaciones b√°sicas
        if (!nombre) {
          mostrarToast('‚ùå El nombre de la tarea es obligatorio', 'error');
          return;
        }
        
        if (!tipo) {
          mostrarToast('‚ùå El tipo de tarea es obligatorio', 'error');
          return;
        }
        
        if (!titulo) {
          mostrarToast('‚ùå El t√≠tulo descriptivo es obligatorio', 'error');
          return;
        }
        
        if (!tiempoInput) {
          mostrarToast('‚ùå El tiempo estimado es obligatorio', 'error');
          return;
        }
        
        const tiempo = parseFloat(tiempoInput);
        if (isNaN(tiempo) || tiempo <= 0) {
          mostrarToast('‚ùå El tiempo estimado debe ser un n√∫mero mayor a 0', 'error');
          return;
        }

        // Recoger datos de los arrays
        const elementosCriticos = recogerElementosCriticos();
        const materiales = recogerMateriales();
        const herramientas = recogerHerramientas();
        const pasos = recogerPasos();

        // Validar pasos
        if (pasos.length === 0) {
          mostrarToast('‚ùå Debe a√±adir al menos un paso de instrucci√≥n', 'error');
          return;
        }

        console.log('üì¶ Datos recogidos:', {
          elementosCriticos: elementosCriticos.length,
          materiales: materiales.length,
          herramientas: herramientas.length,
          pasos: pasos.length
        });

        // Crear objeto de tarea
        const nuevaTarea = {
          tipo: tipo,
          titulo: titulo,
          tiempo: tiempo,
          elementosCriticos: elementosCriticos,
          materiales: materiales,
          herramientas: herramientas,
          pasos: pasos
        };

        // Guardar en tareasGuardadas
        tareasGuardadas[nombre] = nuevaTarea;
        
        // Guardar en localStorage
        localStorage.setItem('tareasInstrucciones', JSON.stringify(tareasGuardadas));
        console.log('üíæ Tarea guardada en localStorage:', nombre);

        // Actualizar tareasBase
        actualizarTareasBase(nombre, tiempo);
        
        // Mostrar mensaje de √©xito
        const mensaje = tareaEditando ? 'Tarea actualizada correctamente' : 'Tarea guardada correctamente';
        mostrarToast(`‚úÖ ${mensaje}`);
        
        // Limpiar y mostrar lista
        limpiarFormulario();
        mostrarTareas();
        mostrarSeccion('lista');
        
      } catch (error) {
        console.error('‚ùå Error al guardar tarea:', error);
        mostrarToast('‚ùå Error al guardar la tarea', 'error');
      }
    }

    // FUNCIONES AUXILIARES PARA RECOGER DATOS
    function recogerElementosCriticos() {
      const elementos = [];
      const criticosElements = document.querySelectorAll('#criticosContainer .array-item');
      
      criticosElements.forEach(item => {
        const inputs = item.querySelectorAll('input, textarea');
        const titulo = inputs[0]?.value.trim() || '';
        const descripcion = inputs[1]?.value.trim() || '';
        const esCritico = inputs[2]?.checked || false;
        
        if (titulo && descripcion) {
          elementos.push({ titulo, descripcion, critico: esCritico });
        }
      });
      
      return elementos;
    }

    function recogerMateriales() {
      const materiales = [];
      const materialesElements = document.querySelectorAll('#materialesContainer .array-item');
      
      materialesElements.forEach(item => {
        const inputs = item.querySelectorAll('input');
        const nombre = inputs[0]?.value.trim() || '';
        const descripcion = inputs[1]?.value.trim() || '';
        const cantidad = parseInt(inputs[2]?.value) || 0;
        const unidad = inputs[3]?.value.trim() || 'unidades';
        
        if (nombre) {
          materiales.push({ nombre, descripcion, cantidad, unidad });
        }
      });
      
      return materiales;
    }

    function recogerHerramientas() {
      const herramientas = [];
      const herramientasElements = document.querySelectorAll('#herramientasContainer .array-item');
      
      herramientasElements.forEach(item => {
        const inputs = item.querySelectorAll('input');
        const nombre = inputs[0]?.value.trim() || '';
        const descripcion = inputs[1]?.value.trim() || '';
        const imagen = inputs[2]?.value.trim() || '';
        
        if (nombre) {
          herramientas.push({ nombre, descripcion, imagen });
        }
      });
      
      return herramientas;
    }

    function recogerPasos() {
      const pasos = [];
      const pasosElements = document.querySelectorAll('#pasosContainer .array-item');
      
      pasosElements.forEach(item => {
        const inputs = item.querySelectorAll('input, textarea');
        const titulo = inputs[0]?.value.trim() || '';
        const descripcion = inputs[1]?.value.trim() || '';
        const imagen = inputs[2]?.value.trim() || '';
        const video = inputs[3]?.value.trim() || '';
        
        if (titulo && descripcion) {
          pasos.push({ titulo, descripcion, imagen, video });
        }
      });
      
      return pasos;
    }

    function actualizarTareasBase(nombre, tiempo) {
      let tareasBase = JSON.parse(localStorage.getItem('tareasBase') || '{}');
      tareasBase[nombre] = tiempo;
      localStorage.setItem('tareasBase', JSON.stringify(tareasBase));
      console.log('‚è± Tiempo actualizado en tareasBase:', nombre, tiempo);
    }

    function mostrarTareas() {
      const container = document.getElementById('tareasLista');
      if (!container) {
        console.error('‚ùå No se encontr√≥ el elemento tareasLista');
        return;
      }
      container.innerHTML = '';

      if (!tareasGuardadas || Object.keys(tareasGuardadas).length === 0) {
        container.innerHTML = '<p>No hay tareas guardadas.</p>';
        return;
      }

      for (const [nombre, tarea] of Object.entries(tareasGuardadas)) {
        const tipoClass = tarea.tipo ? tarea.tipo.toLowerCase() : '';
        const html = `
          <div class="tarea-item">
            <div class="tarea-header">
              <div>
                <span class="tarea-nombre">${nombre}</span>
                <span class="tarea-tipo ${tipoClass}">${tarea.tipo || 'Sin tipo'}</span>
              </div>
              <div class="tarea-acciones">
                <button class="btn-edit" onclick="editarTarea('${nombre}')">‚úèÔ∏è Editar</button>
                <button class="btn-delete" onclick="eliminarTarea('${nombre}')">üóëÔ∏è Eliminar</button>
              </div>
            </div>
            <div class="tarea-detalles">
              <strong>T√≠tulo:</strong> ${tarea.titulo || 'Sin t√≠tulo'}<br>
              <strong>Tiempo:</strong> ${tarea.tiempo || 0} horas<br>
              <strong>Elementos cr√≠ticos:</strong> ${tarea.elementosCriticos?.length || 0}<br>
              <strong>Materiales:</strong> ${tarea.materiales?.length || 0}<br>
              <strong>Herramientas:</strong> ${tarea.herramientas?.length || 0}<br>
              <strong>Pasos:</strong> ${tarea.pasos?.length || 0}
            </div>
          </div>
        `;
        container.innerHTML += html;
      }
    }

    function editarTarea(nombre) {
      console.log('‚úèÔ∏è Editando tarea:', nombre);
      
      const tarea = tareasGuardadas[nombre];
      if (!tarea) {
        mostrarToast('‚ùå Tarea no encontrada', 'error');
        return;
      }

      // Llenar formulario con datos de la tarea
      document.getElementById('tareaNombre').value = nombre;
      document.getElementById('tareaTipo').value = tarea.tipo;
      document.getElementById('tareaTitulo').value = tarea.titulo;
      document.getElementById('tareaTiempo').value = tarea.tiempo;

      // Limpiar contenedores
      document.getElementById('criticosContainer').innerHTML = '';
      document.getElementById('materialesContainer').innerHTML = '';
      document.getElementById('herramientasContainer').innerHTML = '';
      document.getElementById('pasosContainer').innerHTML = '';

      // Llenar elementos cr√≠ticos
      if (tarea.elementosCriticos && tarea.elementosCriticos.length > 0) {
        tarea.elementosCriticos.forEach(critico => {
          agregarCritico();
          const container = document.getElementById('criticosContainer');
          const lastItem = container.lastElementChild;
          const inputs = lastItem.querySelectorAll('input, textarea');
          inputs[0].value = critico.titulo;
          inputs[1].value = critico.descripcion;
          inputs[2].checked = critico.critico;
        });
      } else {
        agregarCritico();
      }

      // Llenar materiales
      if (tarea.materiales && tarea.materiales.length > 0) {
        tarea.materiales.forEach(material => {
          agregarMaterial();
          const container = document.getElementById('materialesContainer');
          const lastItem = container.lastElementChild;
          const inputs = lastItem.querySelectorAll('input');
          inputs[0].value = material.nombre;
          inputs[1].value = material.descripcion;
          inputs[2].value = material.cantidad;
          inputs[3].value = material.unidad;
        });
      } else {
        agregarMaterial();
      }

      // Llenar herramientas
      if (tarea.herramientas && tarea.herramientas.length > 0) {
        tarea.herramientas.forEach(herramienta => {
          agregarHerramienta();
          const container = document.getElementById('herramientasContainer');
          const lastItem = container.lastElementChild;
          const inputs = lastItem.querySelectorAll('input');
          inputs[0].value = herramienta.nombre;
          inputs[1].value = herramienta.descripcion;
          inputs[2].value = herramienta.imagen;
          
          // Mostrar preview si hay imagen
          if (herramienta.imagen) {
            const preview = lastItem.querySelector('.image-preview');
            preview.src = herramienta.imagen;
            preview.style.display = 'block';
          }
        });
      } else {
        agregarHerramienta();
      }

      // Llenar pasos
      if (tarea.pasos && tarea.pasos.length > 0) {
        tarea.pasos.forEach(paso => {
          agregarPaso();
          const container = document.getElementById('pasosContainer');
          const lastItem = container.lastElementChild;
          const inputs = lastItem.querySelectorAll('input, textarea');
          inputs[0].value = paso.titulo;
          inputs[1].value = paso.descripcion;
          inputs[2].value = paso.imagen;
          inputs[3].value = paso.video;
          
          // Mostrar preview si hay imagen
          if (paso.imagen) {
            const preview = lastItem.querySelector('.image-preview');
            preview.src = paso.imagen;
            preview.style.display = 'block';
          }
        });
      } else {
        agregarPaso();
      }

      tareaEditando = nombre;
      mostrarSeccion('formulario');
      mostrarToast(`‚úèÔ∏è Editando tarea: ${nombre}`);
    }

    function eliminarTarea(nombre) {
      if (confirm(`¬øEst√° seguro de que desea eliminar la tarea "${nombre}"?`)) {
        delete tareasGuardadas[nombre];
        localStorage.setItem('tareasInstrucciones', JSON.stringify(tareasGuardadas));
        
        // Actualizar tareasBase tambi√©n
        let tareasBase = JSON.parse(localStorage.getItem('tareasBase') || '{}');
        delete tareasBase[nombre];
        localStorage.setItem('tareasBase', JSON.stringify(tareasBase));
        
        mostrarTareas();
        mostrarToast(`üóëÔ∏è Tarea "${nombre}" eliminada`);
      }
    }

    function mostrarToast(mensaje, tipo = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = mensaje;
      toast.style.display = 'block';
      toast.style.background = tipo === 'error' ? 'var(--danger)' : 'var(--accent)';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>
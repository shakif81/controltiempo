<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‚è± Control de Tiempo ‚Äî Sistema Mejorado</title>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --accent: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --success: #2ecc71;
      --warning: #f39c12;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --bg: #f5f6fa;
      --muted: #e9ecef;
      --card: #fff;
      --danger: #e74c3c;
      --info: #3498db;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: var(--dark);
      line-height: 1.6;
      padding: 16px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }
    
    .wrap {
      width: 100%;
      max-width: 1200px;
    }
    
    h1 {
      text-align: center;
      color: var(--primary);
      margin: 0 0 20px;
      font-size: clamp(1.5rem, 4vw, 2rem);
      font-weight: 700;
    }
    
    label {
      display: block;
      margin-top: 8px;
      color: var(--primary);
      font-weight: 600;
      font-size: clamp(0.9rem, 2vw, 1rem);
    }
    
    input, select, button {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      font-size: 1rem;
      transition: var(--transition);
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      align-items: end;
      margin-top: 10px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      min-height: 85px;
    }
    
    .tiempo-group {
      display: flex;
      flex-direction: column;
    }
    
    .tiempo-input-group {
      display: flex;
      gap: 10px;
      align-items: stretch;
    }
    
    .tiempo-input-group input {
      flex: 1;
      margin: 0;
      min-width: 0;
      height: 46px;
      box-sizing: border-box;
      font-size: clamp(0.9rem, 2vw, 1rem);
    }
    
    .tiempo-convertido {
      background: var(--muted);
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ddd;
      flex: 1;
      min-width: 0;
      height: 46px;
      box-sizing: border-box;
      font-size: clamp(0.8rem, 2vw, 0.9rem);
    }
    
    .instrucciones-group {
      display: flex;
      flex-direction: column;
    }
    
    .btn-instrucciones {
      background: #9b59b6;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--transition);
      height: 46px;
      box-sizing: border-box;
      font-size: clamp(0.9rem, 2vw, 1rem);
      white-space: nowrap;
      font-weight: 600;
    }
    
    .btn-instrucciones:hover {
      background: #8e44ad;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(155, 89, 182, 0.3);
    }
    
    .btn-instrucciones:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .row button {
      font-size: clamp(0.8rem, 2vw, 0.9rem);
      padding: 12px 10px;
      white-space: nowrap;
      min-height: 50px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
    }
    
    .row button:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    #btnStart { background: #0984e3; color: white; } 
    #btnTerminar { background: var(--danger); color: white; } 
    #btnReset { background: var(--success); color: white; }
    #btnSilenciar { background: #95a5a6; color: white; }
    #btnEstadisticas { background: #16a085; color: white; }
    #btnExportExcel { background: #27ae60; color: white; }
    #btnResetTabla { background: #e74c3c; color: white; }
    #btnAdmin { background: #34495e; color: white; }
    
    #cronometro {
      background: var(--muted);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      margin-top: 15px;
      font-size: clamp(1.1rem, 3vw, 1.4rem);
      font-weight: bold;
      box-shadow: var(--shadow);
    }
    
    .table-wrap {
      margin-top: 15px;
      background: var(--card);
      border-radius: 12px;
      padding: 12px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: var(--shadow);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 980px;
      font-size: clamp(0.8rem, 2vw, 0.93rem);
    }
    
    th, td {
      padding: 12px 10px;
      border: 1px solid #e6e6e6;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    th {
      background: #f1f2f6;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    
    #inpTiempo::-webkit-outer-spin-button,
    #inpTiempo::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    #inpTiempo {
      -moz-appearance: textfield;
    }
    
    .progreso-container {
      margin-top: 15px;
      background: var(--muted);
      padding: 15px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }
    
    .progreso-bar {
      width: 100%;
      height: 28px;
      background: #f1f2f6;
      border-radius: 14px;
      overflow: hidden;
      position: relative;
    }
    
    .progreso-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), #27ae60);
      border-radius: 14px;
      transition: width 0.3s ease, background 0.3s ease;
      width: 0%;
    }
    
    .progreso-fill.excedido {
      background: linear-gradient(90deg, var(--danger), #c0392b);
    }
    
    .progreso-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: 600;
      font-size: clamp(0.8rem, 2vw, 0.9rem);
      color: var(--primary);
      pointer-events: none;
    }
    
    .diff-plus { color: var(--success); font-weight: 700; }
    .diff-minus { color: var(--danger); font-weight: 700; }
    
    #floatingTotal {
      position: sticky;
      left: 0;
      bottom: 0;
      background: var(--card);
      border-radius: 12px;
      padding: 16px 24px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.12);
      z-index: 1001;
      font-weight: 700;
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
      margin-top: 20px;
      border: 2px solid var(--success);
      font-size: clamp(1rem, 2.5vw, 1.1rem);
    }
    
    #toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--success);
      color: #fff;
      padding: 15px 24px;
      border-radius: 10px;
      display: none;
      z-index: 1002;
      font-size: clamp(0.9rem, 2vw, 1rem);
      text-align: center;
      max-width: 90%;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      font-weight: 600;
    }

    /* NUEVOS ESTILOS PARA MEJORAS */
    .modal-estadisticas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      padding: 16px;
      box-sizing: border-box;
    }
    
    .modal-estadisticas .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 95%;
      width: 100%;
      max-height: 95vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    
    .estadisticas-container {
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .estadistica-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-left: 4px solid var(--secondary);
    }
    
    .estadistica-card h3 {
      margin-bottom: 15px;
      color: var(--primary);
      font-size: 1.1rem;
    }
    
    .estadistica-valor {
      font-size: 2rem;
      font-weight: 700;
      color: var(--secondary);
      margin-bottom: 10px;
    }
    
    .estadistica-desc {
      color: #666;
      font-size: 0.9rem;
    }
    
    .grafico-container {
      grid-column: 1 / -1;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .barra-grafico {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .barra-etiqueta {
      width: 150px;
      font-weight: 600;
      color: var(--primary);
    }
    
    .barra-contenedor {
      flex: 1;
      height: 30px;
      background: #f1f2f6;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }
    
    .barra-relleno {
      height: 100%;
      background: linear-gradient(90deg, var(--secondary), var(--accent));
      border-radius: 15px;
      transition: width 0.5s ease;
    }
    
    .barra-porcentaje {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: 600;
      color: var(--primary);
      font-size: 0.9rem;
    }
    
    .asistente-virtual {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: var(--secondary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
      z-index: 1000;
      transition: var(--transition);
    }
    
    .asistente-virtual:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }
    
    .asistente-icono {
      font-size: 1.5rem;
      color: white;
    }
    
    .chat-asistente {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 300px;
      height: 400px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      z-index: 1001;
      overflow: hidden;
    }
    
    .chat-header {
      background: var(--secondary);
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-body {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .mensaje {
      padding: 10px 15px;
      border-radius: 18px;
      max-width: 80%;
      font-size: 0.9rem;
    }
    
    .mensaje-asistente {
      background: #f1f2f6;
      align-self: flex-start;
      border-bottom-left-radius: 5px;
    }
    
    .mensaje-usuario {
      background: var(--secondary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }
    
    .chat-input {
      padding: 15px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
    }
    
    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
    }
    
    .chat-input button {
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      padding: 16px;
      box-sizing: border-box;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 95%;
      width: 100%;
      max-height: 95vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      margin: auto;
    }

/* CORRECCI√ìN PARA EL HEADER DE INSTRUCCIONES */
.modal-header {
  padding: 25px 20px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
  color: var(--primary);
  border-radius: 16px 16px 0 0;
  position: sticky;
  top: 0;
  z-index: 10;
  flex-shrink: 0;
  position: relative;
  overflow: hidden;
}

.modal-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: linear-gradient(90deg, var(--secondary), var(--accent));
}

.modal-header h2 {
  margin: 0;
  flex: 1;
  font-size: clamp(1.3rem, 3vw, 1.6rem);
  text-align: center;
  padding-right: 40px;
  font-weight: 700;
  color: var(--primary);
  position: relative;
  display: inline-block;
}

.modal-header h2::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 10%;
  width: 80%;
  height: 3px;
  background: var(--secondary);
  border-radius: 3px;
}

.close-modal {
  background: none;
  border: none;
  color: var(--primary);
  font-size: 28px;
  cursor: pointer;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: var(--transition);
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 11;
}

.close-modal:hover {
  background: rgba(52, 152, 219, 0.1);
  color: var(--secondary);
  transform: translateY(-50%) scale(1.1);
}
    .modal-body {
      padding: 20px;
      min-height: 200px;
      font-size: clamp(0.9rem, 2vw, 1rem);
      flex: 1;
      overflow-y: auto;
    }

    /* ELIMINAR NAVEGACI√ìN DE INSTRUCCIONES */
    .navegacion-instrucciones {
      display: none !important;
    }

    .btn-navegacion, .contador-paginas, .indicadores-paginas {
      display: none !important;
    }

    #excedido {
      display: none;
      color: var(--danger);
      font-weight: 700;
      margin-top: 10px;
      text-align: center;
      padding: 10px;
      font-size: clamp(0.9rem, 2vw, 1rem);
      background: #ffeaea;
      border-radius: 8px;
      border-left: 4px solid var(--danger);
    }

    /* ESTILOS PARA INSTRUCCIONES */
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    
    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .card-icon {
      width: 40px;
      height: 40px;
      background: var(--secondary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      color: white;
      font-size: 1.2rem;
    }
    
    .card-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    .critical-item {
      background: #fff8e1;
      border-left: 4px solid var(--warning);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .critical-title {
      font-weight: 700;
      color: var(--warning);
      margin-bottom: 8px;
      font-size: 1.1rem;
    }
    
    .critical-desc {
      color: #666;
      font-size: 0.95rem;
    }
    
    .material-item, .tool-item {
      padding: 12px 15px;
      margin-bottom: 10px;
      background: #f8f9fa;
      border-radius: 10px;
      display: flex;
      align-items: center;
      transition: var(--transition);
      border-left: 3px solid var(--success);
    }
    
    .tool-item {
      border-left-color: var(--secondary);
    }
    
    .material-name, .tool-name {
      font-weight: 600;
      color: var(--primary);
    }
    
    .material-desc, .tool-desc {
      color: #666;
      font-size: 0.9rem;
      margin-top: 3px;
    }

    .pagina-instrucciones {
      display: block;
      margin-bottom: 25px;
      padding-bottom: 25px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .pagina-instrucciones:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    /* ESTILOS PARA PASOS CR√çTICOS - NUEVOS */
    .paso-critico {
      border: 3px solid #e74c3c !important;
      background: #ffeaea !important;
      position: relative;
      animation: pulse-critico 2s infinite;
    }

    @keyframes pulse-critico {
      0% { border-color: #e74c3c; }
      50% { border-color: #ff6b6b; box-shadow: 0 0 15px rgba(231, 76, 60, 0.5); }
      100% { border-color: #e74c3c; }
    }

    .alerta-critica {
      position: absolute;
      top: -10px;
      right: -10px;
      background: #e74c3c;
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 10;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .btn-verificar-critico {
      background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
      color: white !important;
      border: none !important;
      padding: 12px 20px !important;
      border-radius: 8px !important;
      font-weight: bold !important;
      cursor: pointer !important;
      margin-top: 15px !important;
      width: 100% !important;
      font-size: 1rem !important;
      transition: all 0.3s ease !important;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4) !important;
    }

    .btn-verificar-critico:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6) !important;
    }

    .btn-verificar-critico:active {
      transform: translateY(0) !important;
    }

    .modal-verificacion {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }

    .modal-verificacion-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      border: 4px solid #e74c3c;
      animation: modalAppear 0.3s ease;
    }

    @keyframes modalAppear {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .modal-verificacion h3 {
      color: #e74c3c;
      margin-bottom: 15px;
      font-size: 1.4rem;
    }

    .modal-verificacion p {
      margin-bottom: 20px;
      color: #333;
      line-height: 1.5;
    }

    .btn-confirmar-critico {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
      margin: 5px;
    }

    .btn-confirmar-critico:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .btn-cancelar-critico {
      background: #95a5a6;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
      margin: 5px;
    }

    .btn-cancelar-critico:hover {
      background: #7f8c8d;
      transform: translateY(-2px);
    }

    /* ESTILOS PARA CAJONES DE MATERIALES */
.materiales-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 15px;
  margin-top: 10px;
}

.cajon-material {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  overflow: hidden;
  transition: var(--transition);
}

.cajon-material:hover {
  border-color: var(--secondary);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.cajon-header {
  background: var(--secondary);
  color: white;
  padding: 12px 15px;
}

.cajon-titulo {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
}

.cajon-contenido {
  padding: 15px;
}

.material-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid #e9ecef;
}

.material-item:last-child {
  border-bottom: none;
}

.material-info {
  flex: 1;
}

.material-nombre {
  font-weight: 600;
  color: var(--primary);
  font-size: 0.95rem;
}

.material-unidades {
  display: flex;
  align-items: center;
  gap: 8px;
  background: white;
  padding: 6px 12px;
  border-radius: 20px;
  border: 1px solid #ddd;
}

.material-cantidad {
  font-weight: 700;
  color: var(--accent);
  font-size: 1.1rem;
}

.material-unidad {
  font-weight: 600;
  color: var(--primary);
  font-size: 0.85rem;
  text-transform: lowercase;
}

/* ESTILOS PARA IM√ÅGENES DE HERRAMIENTAS */
.herramienta-imagen {
  text-align: center;
  margin: 10px 0;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 8px;
}

.herramienta-imagen img {
  max-width: 100%;
  max-height: 200px;
  border-radius: 6px;
  border: 1px solid #ddd;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.paso-imagen {
  text-align: center;
  margin: 15px 0;
}

.paso-imagen img {
  max-width: 100%;
  max-height: 300px;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* BOT√ìN DE VER IMAGEN M√ÅS PEQUE√ëO */
.btn-ver-imagen {
  background: linear-gradient(135deg, var(--secondary), #2980b9) !important;
  color: white !important;
  border: none !important;
  padding: 8px 12px !important;
  border-radius: 6px !important;
  cursor: pointer !important;
  font-size: 0.8rem !important;
  transition: all 0.3s ease !important;
  font-weight: 600 !important;
  margin-top: 8px !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 6px !important;
  box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3) !important;
}

.btn-ver-imagen:hover {
  background: linear-gradient(135deg, #2980b9, #1f618d) !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 12px rgba(52, 152, 219, 0.5) !important;
}

.btn-ver-imagen:active {
  transform: translateY(-1px) !important;
}

/* FLECHAS FLOTANTES MANTENIDAS */
.flechas-flotantes {
  position: fixed;
  bottom: 100px;
  left: 0;
  right: 0;
  display: none;
  justify-content: space-between;
  padding: 0 20px;
  z-index: 100;
  pointer-events: none;
}

.flecha-flotante {
  width: 50px;
  height: 50px;
  background: rgba(52, 152, 219, 0.9);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  pointer-events: all;
  transition: all 0.3s ease;
  border: none;
}

.flecha-flotante:active {
  transform: scale(0.95);
  background: rgba(41, 128, 185, 0.9);
}

/* Responsive: Mostrar flechas flotantes en m√≥viles */
@media (max-width: 768px) {
  .flechas-flotantes {
    display: flex;
  }
  
  .estadisticas-container {
    grid-template-columns: 1fr;
  }
  
  .chat-asistente {
    width: calc(100% - 40px);
    right: 20px;
    left: 20px;
  }
  
  .asistente-virtual {
    bottom: 80px;
  }
}

  </style>
</head>
<body>
  <div class="wrap">
    <h1>‚è± Control de Tiempo ‚Äî Sistema Mejorado</h1>

    <label for="inpOperacion">N¬∞ de Operaci√≥n</label>
    <input id="inpOperacion" placeholder="Ej: 234 o Lote 12">

    <div class="controls-grid">
      <div class="control-group">
        <label for="selTipo" style="margin-bottom: 5px;">Tipo</label>
        <select id="selTipo">
          <option value="">‚Äî Selecciona tipo ‚Äî</option>
          <option value="DC3">DC3</option>
          <option value="MS3">MS3</option>
          <option value="Personalizada">Personalizada</option>
        </select>
      </div>

      <div class="control-group">
        <label for="selTarea" style="margin-bottom: 5px;">Tarea</label>
        <select id="selTarea">
          <option value="">‚Äî Elige tipo primero ‚Äî</option>
        </select>
        <div id="divPersonalizada" style="display:none;margin-top:8px">
          <input id="inpNombrePersonalizado" placeholder="Nombre de tarea...">
        </div>
      </div>

      <div class="control-group tiempo-group">
        <label for="inpTiempo" style="margin-bottom: 5px;">Tiempo estimado (horas)</label>
        <div class="tiempo-input-group">
          <input id="inpTiempo" type="number" step="0.01" min="0" placeholder="Ej: 1.50">
          <div id="minutosConvertidos" class="tiempo-convertido">00:00:00</div>
        </div>
      </div>

      <div class="control-group instrucciones-group">
        <label for="btnInstrucciones" style="margin-bottom: 5px;">&nbsp;</label>
        <button id="btnInstrucciones" class="btn-instrucciones">
          üìö Instrucciones
        </button>
      </div>
    </div>

    <div id="cronometro">Restante: 00:00:00</div>
    
    <div class="progreso-container">
      <div class="progreso-bar">
        <div class="progreso-fill" id="progresoFill"></div>
        <div class="progreso-text" id="progresoText">0%</div>
      </div>
    </div>
    
    <div id="excedido">-00:00:00 excedido</div>

    <div class="row">
      <button id="btnStart">‚ñ∂Ô∏è Iniciar</button>
      <button id="btnTerminar" disabled>‚èπÔ∏è Terminar</button>
      <button id="btnReset">üîÑ Reiniciar</button>
      <button id="btnSilenciar">üîä Silenciar</button>
      <button id="btnEstadisticas">üìä Estad√≠sticas</button>
      <button id="btnExportExcel">üìä Descargar Excel</button>
      <button id="btnResetTabla">üóëÔ∏è Resetear</button>
      <button id="btnAdmin">‚öôÔ∏è Admin</button>
    </div>

    <div class="filtros-container">
      <div class="filtro-item">
        <label for="filtroFecha">Filtrar por fecha</label>
        <input id="filtroFecha" type="date">
      </div>
      <div class="filtro-item">
        <label for="filtroOperacion">Filtrar por N¬∫ de Operaci√≥n</label>
        <input id="filtroOperacion" placeholder="Ej: 234">
      </div>
      <div class="filtro-item limpiar">
        <label for="filtroLimpiar">&nbsp;</label>
        <button id="filtroLimpiar">üßπ Limpiar filtros</button>
      </div>
    </div>

    <div class="table-wrap">
      <table id="tabla">
        <thead>
          <tr>
            <th>N¬∫ Operaci√≥n</th>
            <th>Tipo</th>
            <th>Tarea</th>
            <th>Estimado</th>
            <th>Tiempo Real</th>
            <th>Diferencia</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="floatingTotal">
      <div>Total d√≠a:</div>
      <div id="floatingTotalValue" style="min-width:120px;text-align:center;color:var(--success)">+00:00:00</div>
    </div>
  </div>

  <!-- MODAL DE ESTAD√çSTICAS VISUALES -->
  <div id="modalEstadisticas" class="modal-estadisticas">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìä Estad√≠sticas Visuales</h2>
        <button class="close-modal" aria-label="Cerrar modal">&times;</button>
      </div>
      <div class="estadisticas-container" id="estadisticasBody">
        <!-- Las estad√≠sticas se cargar√°n aqu√≠ din√°micamente -->
      </div>
    </div>
  </div>

  <!-- ASISTENTE VIRTUAL -->
  <div class="asistente-virtual" id="asistenteBtn">
    <div class="asistente-icono">ü§ñ</div>
  </div>
  
  <div class="chat-asistente" id="chatAsistente">
    <div class="chat-header">
      <div>Asistente Virtual</div>
      <button id="cerrarChat" style="background:none;border:none;color:white;font-size:1.2rem;cursor:pointer">√ó</button>
    </div>
    <div class="chat-body" id="chatBody">
      <div class="mensaje mensaje-asistente">
        ¬°Hola! Soy tu asistente virtual. ¬øEn qu√© puedo ayudarte?
      </div>
    </div>
    <div class="chat-input">
      <input type="text" id="inputChat" placeholder="Escribe tu pregunta...">
      <button id="enviarChat">‚û§</button>
    </div>
  </div>

  <!-- MODAL DE INSTRUCCIONES -->
  <div id="modalInstrucciones" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitulo">Instrucciones de Tarea</h2>
        <button class="close-modal" aria-label="Cerrar modal">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Las p√°ginas de instrucciones se cargar√°n aqu√≠ din√°micamente -->
      </div>
    </div>
  </div>

  <!-- MODAL DE VERIFICACI√ìN PARA PASOS CR√çTICOS -->
  <div id="modalVerificacionCritico" class="modal-verificacion">
    <div class="modal-verificacion-content">
      <h3>‚ö†Ô∏è PASO CR√çTICO - VERIFICACI√ìN REQUERIDA</h3>
      <p id="textoVerificacionCritico">Antes de continuar, debe verificar que ha completado correctamente este paso cr√≠tico.</p>
      <div style="margin-top: 25px;">
        <button class="btn-confirmar-critico" onclick="confirmarPasoCritico()">‚úÖ CONFIRMAR COMPLETADO</button>
        <button class="btn-cancelar-critico" onclick="cancelarPasoCritico()">‚Ü©Ô∏è VOLVER AL PASO</button>
      </div>
    </div>
  </div>

  <!-- FLECHAS FLOTANTES MANTENIDAS -->
  <div class="flechas-flotantes" id="flechasFlotantes">
    <button class="flecha-flotante" id="flechaAnterior">‚óÄ</button>
    <button class="flecha-flotante" id="flechaSiguiente">‚ñ∂</button>
  </div>

  <div id="toast"></div>
  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
  <audio id="warningBeep" src="https://actions.google.com/sounds/v1/cartoon/cartoon_whistle.ogg" preload="auto"></audio>

<script>
// =============================================
// VARIABLES GLOBALES
// =============================================
let inicioMs = 0;
let rafId = null;
let tiempoEstandar = 0;
let silenciado = false;
let alerta10minMostrada = false;
let alerta5minMostrada = false;
let alertaExcedidoMostrada = false;
let modoPrueba = false;

// Variables para pasos cr√≠ticos
let pasoCriticoActual = null;
let indicePasoCritico = -1;

// TAREAS PREDEFINIDAS
const tareasBase = {
  "Bandeja AT Derecha":1.27,
  "Bandeja AT Izquierda":1.27,
  "Contactor QA1200, QA2200":1.66,
  "Contactor QA1240, QA2240":2.46,
  "DCU":1.80,
  "Contactor QB1242, QB2242, Transductores tensiones, condensador":2.11,
  "Desmontar Caldereria y Placa Conectores":2.31,
  "Psus, Switch, Bombas":1.62,
  "Premecanico Transdutores Corriente Izquierdo":1.83,
  "Premecanico Transductores Corriente Derecho":1.83,
  "PreElectrico Transductores Corriente y BusBars":2.07,
  "DC-LINK Superior y Inferior":2.19,
  "Conexion SZ/KK y I/O":1.50
};

// =============================================
// SISTEMA DE PASOS CR√çTICOS - FUNCIONES CORREGIDAS
// =============================================

function verificarPasoCritico(pasoIndex, pasoData) {
    pasoCriticoActual = pasoData;
    indicePasoCritico = pasoIndex;
    
    const modal = document.getElementById('modalVerificacionCritico');
    const texto = document.getElementById('textoVerificacionCritico');
    
    texto.textContent = `PASO CR√çTICO: ${pasoData.titulo}\n\n${pasoData.descripcion}\n\nAntes de continuar, verifique que ha completado correctamente este paso.`;
    
    modal.style.display = 'flex';
    
    // Bloquear navegaci√≥n
    document.getElementById('btnSiguiente').disabled = true;
    document.getElementById('btnAnterior').disabled = true;
}

function confirmarPasoCritico() {
    const modal = document.getElementById('modalVerificacionCritico');
    modal.style.display = 'none';
    
    // Desbloquear navegaci√≥n
    document.getElementById('btnSiguiente').disabled = false;
    document.getElementById('btnAnterior').disabled = false;
    
    // Marcar el bot√≥n como verificado en la p√°gina actual
    const paginaActualElement = document.querySelector('.pagina-instrucciones .btn-verificar-critico');
    
    if (paginaActualElement) {
        paginaActualElement.classList.add('verificado');
        paginaActualElement.textContent = '‚úÖ PASO CR√çTICO VERIFICADO';
        paginaActualElement.style.background = '#27ae60';
        paginaActualElement.style.cursor = 'default';
    }
    
    pasoCriticoActual = null;
    indicePasoCritico = -1;
    
    toast('‚úÖ Paso cr√≠tico verificado correctamente', '#2ecc71');
}

function cancelarPasoCritico() {
    const modal = document.getElementById('modalVerificacionCritico');
    modal.style.display = 'none';
    
    // Desbloquear navegaci√≥n pero mantener en la p√°gina actual
    document.getElementById('btnSiguiente').disabled = false;
    document.getElementById('btnAnterior').disabled = false;
    
    pasoCriticoActual = null;
    indicePasoCritico = -1;
    
    toast('‚Ü©Ô∏è Verifique el paso cr√≠tico antes de continuar', '#f39c12');
}

// =============================================
// FUNCIONES DE INSTRUCCIONES (MODIFICADAS)
// =============================================

function obtenerInstruccionesTareas() {
  const tareasAdmin = JSON.parse(localStorage.getItem('tareasInstrucciones') || '{}');
  
  if (Object.keys(tareasAdmin).length > 0) {
    return tareasAdmin;
  }
  
  // Instrucciones predeterminadas
  return {
    "Bandeja AT Derecha": {
      titulo: "Instalaci√≥n Bandeja AT Derecha",
      tipo: "DC3",
      tiempo: 1.27,
      elementosCriticos: [
        {
          titulo: "TORNILLOS DE ANCLAJE",
          descripcion: "Verificar que los tornillos de anclaje sean de grado 8.8 o superior",
          critico: true
        }
      ],
      materiales: [
        {
          nombre: "Tornillos M8x40",
          descripcion: "Tornillos de fijaci√≥n grado 8.8",
          cantidad: 6,
          unidad: "unidades"
        }
      ],
      herramientas: [
        {
          nombre: "Llave torque 25Nm",
          descripcion: "Para apriete controlado de tornillos",
          imagen: ""
        }
      ],
      pasos: [
        {
          titulo: "Preparaci√≥n del √°rea",
          descripcion: "Limpiar y marcar la posici√≥n donde ir√° la bandeja",
          imagen: "",
          critico: true
        },
        {
          titulo: "Instalaci√≥n de soportes",
          descripcion: "Colocar y fijar los soportes de la bandeja",
          imagen: "",
          critico: false
        }
      ]
    }
  };
}

function mostrarInstrucciones() {
  const tareaSeleccionada = document.getElementById('selTarea').value;
  if (!tareaSeleccionada) {
    toast('üìù Primero selecciona una tarea', '#f39c12');
    return;
  }

  const instruccionesTareas = obtenerInstruccionesTareas();
  const instruccion = instruccionesTareas[tareaSeleccionada];
  
  if (!instruccion) {
    toast('üìù No hay instrucciones disponibles para esta tarea', '#f39c12');
    return;
  }
  
  const modal = document.getElementById('modalInstrucciones');
  const titulo = document.getElementById('modalTitulo');
  const body = document.getElementById('modalBody');
  
  titulo.textContent = instruccion.titulo || tareaSeleccionada;
  
  // Crear p√°ginas de instrucciones (todas visibles en scroll)
  let contenidoHTML = '';

  // P√ÅGINA 1: Informaci√≥n + Elementos Cr√≠ticos
  contenidoHTML += `
    <div class="pagina-instrucciones">
      <div class="card">
        <div class="card-header">
          <div class="card-icon">üìã</div>
          <h2 class="card-title">Informaci√≥n de la Tarea</h2>
        </div>
        <div style="padding: 15px;">
          <p><strong>Tipo:</strong> ${instruccion.tipo || 'No especificado'}</p>
          <p><strong>Tiempo estimado:</strong> ${instruccion.tiempo || document.getElementById('inpTiempo').value} horas</p>
          <p><strong>Dificultad:</strong> Media</p>
        </div>
      </div>
  `;
  
  // ELEMENTOS CR√çTICOS EN P√ÅGINA 1
  if (instruccion.elementosCriticos && instruccion.elementosCriticos.length > 0) {
    contenidoHTML += `
      <div class="card">
        <div class="card-header">
          <div class="card-icon">‚ö†Ô∏è</div>
          <h2 class="card-title">Elementos Cr√≠ticos</h2>
        </div>
    `;
    instruccion.elementosCriticos.forEach(critico => {
      contenidoHTML += `
        <div class="critical-item">
          <h3 class="critical-title">${critico.titulo}</h3>
          <p class="critical-desc">${critico.descripcion}</p>
        </div>
      `;
    });
    contenidoHTML += `</div>`;
  }
  contenidoHTML += `</div>`;
  
  // P√ÅGINA 2: Materiales + Herramientas
  if ((instruccion.materiales && instruccion.materiales.length > 0) || 
      (instruccion.herramientas && instruccion.herramientas.length > 0)) {
    
    contenidoHTML += `<div class="pagina-instrucciones">`;
    
    // MATERIALES EN P√ÅGINA 2 - CON CAJONES
if (instruccion.materiales && instruccion.materiales.length > 0) {
  contenidoHTML += `
    <div class="card">
      <div class="card-header">
        <div class="card-icon">üì¶</div>
        <h2 class="card-title">Materiales Necesarios</h2>
      </div>
      <div style="padding: 15px;">
        <div class="materiales-grid">
  `;
  
  // Agrupar materiales por tipo o categor√≠a
  const materialesAgrupados = {};
  instruccion.materiales.forEach(material => {
    const categoria = material.descripcion || 'General';
    if (!materialesAgrupados[categoria]) {
      materialesAgrupados[categoria] = [];
    }
    materialesAgrupados[categoria].push(material);
  });
  
  // Crear cajones para cada categor√≠a
  Object.entries(materialesAgrupados).forEach(([categoria, materiales]) => {
    contenidoHTML += `
      <div class="cajon-material">
        <div class="cajon-header">
          <h3 class="cajon-titulo">${categoria}</h3>
        </div>
        <div class="cajon-contenido">
    `;
    
    materiales.forEach(material => {
      contenidoHTML += `
        <div class="material-item">
          <div class="material-info">
            <div class="material-nombre">${material.nombre}</div>
          </div>
          <div class="material-unidades">
            <span class="material-cantidad">${material.cantidad}</span>
            <span class="material-unidad">${material.unidad}</span>
          </div>
        </div>
      `;
    });
    
    contenidoHTML += `
        </div>
      </div>
    `;
  });
  
  contenidoHTML += `
        </div>
      </div>
    </div>
  `;
}
    
    // HERRAMIENTAS EN P√ÅGINA 2 - CON BOT√ìN PEQUE√ëO PARA IM√ÅGENES
   if (instruccion.herramientas && instruccion.herramientas.length > 0) {
  contenidoHTML += `
    <div class="card">
      <div class="card-header">
        <div class="card-icon">üõ†Ô∏è</div>
        <h2 class="card-title">Herramientas Necesarias</h2>
      </div>
  `;
  instruccion.herramientas.forEach((herramienta, index) => {
    let imagenHTML = '';
    // BOT√ìN M√ÅS PEQUE√ëO PARA VER IMAGEN SI EXISTE
    if (herramienta.imagen && herramienta.imagen.trim() !== '') {
      imagenHTML = `
        <div class="herramienta-imagen" style="margin-top: 10px;">
          <button class="btn-ver-imagen" 
                  onclick="mostrarImagenHerramienta('${herramienta.imagen.replace(/'/g, "\\'")}', '${herramienta.nombre.replace(/'/g, "\\'")}')">
            üëÅÔ∏è Ver imagen
          </button>
        </div>
      `;
    }
    
    contenidoHTML += `
      <div class="tool-item">
        <div style="flex: 1;">
          <div class="tool-name">${herramienta.nombre}</div>
          <div class="tool-desc">${herramienta.descripcion}</div>
          ${imagenHTML}
        </div>
      </div>
    `;
  });
  contenidoHTML += `</div>`;
}
    
    contenidoHTML += `</div>`;
  }
  
  // P√ÅGINAS SIGUIENTES: Cada paso individual
  if (instruccion.pasos && instruccion.pasos.length > 0) {
    instruccion.pasos.forEach((paso, index) => {
      // AGREGAR CLASE CR√çTICA SI EL PASO ES CR√çTICO
      const claseCritica = paso.critico ? 'paso-critico' : '';
      
      contenidoHTML += `<div class="pagina-instrucciones">`;
      contenidoHTML += `
        <div class="card ${claseCritica}">
          <div class="card-header">
            <div class="card-icon">${index + 1}</div>
            <h2 class="card-title">${paso.titulo}</h2>
            ${paso.critico ? '<div class="alerta-critica">‚ö†Ô∏è CR√çTICO</div>' : ''}
          </div>
          <div style="padding: 15px;">
            <p style="margin-bottom: 15px; line-height: 1.6;">${paso.descripcion}</p>
      `;
      
      // MOSTRAR IMAGEN DEL PASO SI EXISTE
      if (paso.imagen && paso.imagen.trim() !== '') {
        contenidoHTML += `
          <div class="paso-imagen">
            <img src="${paso.imagen}" alt="Paso ${index + 1}" 
                 onerror="this.style.display='none'">
          </div>
        `;
      }
      
      // AGREGAR BOT√ìN DE VERIFICACI√ìN SI ES PASO CR√çTICO
      if (paso.critico) {
        contenidoHTML += `
          <button class="btn-verificar-critico" data-paso='${JSON.stringify(paso).replace(/'/g, "&#39;")}'>
            ‚úÖ VERIFICAR PASO CR√çTICO PARA CONTINUAR
          </button>
        `;
      }
      
      contenidoHTML += `</div></div></div>`;
    });
  }
  
  body.innerHTML = contenidoHTML;
  
  modal.style.display = 'flex';
  
  // Agregar event listeners para botones cr√≠ticos
  setTimeout(() => {
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('btn-verificar-critico')) {
        const pasoData = JSON.parse(e.target.getAttribute('data-paso'));
        verificarPasoCritico(0, pasoData);
      }
    });
  }, 500);
}

// =============================================
// FUNCIONES PRINCIPALES
// =============================================

// 1. ESTAD√çSTICAS VISUALES
function mostrarEstadisticasVisuales() {
  const hist = JSON.parse(localStorage.getItem('historial')||'[]');
  
  if (hist.length === 0) {
    toast('üìä No hay datos para mostrar estad√≠sticas', '#f39c12');
    return;
  }
  
  const totalTareas = hist.length;
  let tiempoTotalEstimado = 0;
  let tiempoTotalReal = 0;
  let tareasCompletadasATiempo = 0;
  let tareasExcedidas = 0;
  let tiempoAhorradoTotal = 0;
  let tiempoExcedidoTotal = 0;
  
  const statsPorTipo = {};
  
  hist.forEach(tarea => {
    tiempoTotalEstimado += tarea.estimado || 0;
    const tiempoRealHoras = msFromHHMMSS(tarea.real) / 3600000;
    tiempoTotalReal += tiempoRealHoras;
    
    if (tarea.signo === '+') {
      tareasCompletadasATiempo++;
      tiempoAhorradoTotal += msFromHHMMSS(tarea.diferencia) / 3600000;
    } else {
      tareasExcedidas++;
      tiempoExcedidoTotal += msFromHHMMSS(tarea.diferencia) / 3600000;
    }
    
    if (!statsPorTipo[tarea.tipo]) {
      statsPorTipo[tarea.tipo] = { count: 0, tiempoTotal: 0 };
    }
    statsPorTipo[tarea.tipo].count++;
    statsPorTipo[tarea.tipo].tiempoTotal += tiempoRealHoras;
  });
  
  const eficiencia = ((tiempoTotalEstimado / tiempoTotalReal) * 100).toFixed(1);
  const porcentajeExitos = ((tareasCompletadasATiempo / totalTareas) * 100).toFixed(1);
  
  const estadisticasBody = document.getElementById('estadisticasBody');
  estadisticasBody.innerHTML = `
    <div class="estadistica-card">
      <h3>üìà Resumen General</h3>
      <div class="estadistica-valor">${totalTareas}</div>
      <div class="estadistica-desc">Total de tareas registradas</div>
    </div>
    
    <div class="estadistica-card">
      <h3>‚úÖ Tareas Completadas</h3>
      <div class="estadistica-valor" style="color:var(--success)">${tareasCompletadasATiempo}</div>
      <div class="estadistica-desc">${porcentajeExitos}% de efectividad</div>
    </div>
    
    <div class="estadistica-card">
      <h3>‚è∞ Tiempo Total</h3>
      <div class="estadistica-valor" style="color:var(--info)">${tiempoTotalReal.toFixed(1)}h</div>
      <div class="estadistica-desc">De ${tiempoTotalEstimado.toFixed(1)}h estimadas</div>
    </div>
    
    <div class="estadistica-card">
      <h3>‚ö° Eficiencia</h3>
      <div class="estadistica-valor" style="color:${eficiencia >= 100 ? 'var(--success)' : 'var(--warning)'}">${eficiencia}%</div>
      <div class="estadistica-desc">Rendimiento vs estimado</div>
    </div>
    
    <div class="grafico-container">
      <h3>üìä Distribuci√≥n de Tareas por Tipo</h3>
      ${Object.entries(statsPorTipo).map(([tipo, data]) => {
        const porcentaje = ((data.count / totalTareas) * 100).toFixed(1);
        return `
          <div class="barra-grafico">
            <div class="barra-etiqueta">${tipo}</div>
            <div class="barra-contenedor">
              <div class="barra-relleno" style="width: ${porcentaje}%"></div>
              <div class="barra-porcentaje">${data.count} tareas (${porcentaje}%)</div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
  
  document.getElementById('modalEstadisticas').style.display = 'flex';
}

// 2. ASISTENTE VIRTUAL
function inicializarAsistente() {
  const asistenteBtn = document.getElementById('asistenteBtn');
  const chatAsistente = document.getElementById('chatAsistente');
  const cerrarChat = document.getElementById('cerrarChat');
  const enviarChat = document.getElementById('enviarChat');
  const inputChat = document.getElementById('inputChat');
  
  asistenteBtn.addEventListener('click', function() {
    chatAsistente.style.display = chatAsistente.style.display === 'flex' ? 'none' : 'flex';
  });
  
  cerrarChat.addEventListener('click', function() {
    chatAsistente.style.display = 'none';
  });
  
  function enviarMensaje() {
    const mensaje = inputChat.value.trim();
    if (!mensaje) return;
    
    a√±adirMensaje(mensaje, 'usuario');
    inputChat.value = '';
    
    setTimeout(() => {
      const respuesta = procesarConsulta(mensaje);
      a√±adirMensaje(respuesta, 'asistente');
    }, 1000);
  }
  
  enviarChat.addEventListener('click', enviarMensaje);
  inputChat.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') enviarMensaje();
  });
}

function a√±adirMensaje(texto, tipo) {
  const chatBody = document.getElementById('chatBody');
  const mensajeDiv = document.createElement('div');
  mensajeDiv.className = `mensaje mensaje-${tipo}`;
  mensajeDiv.textContent = texto;
  chatBody.appendChild(mensajeDiv);
  chatBody.scrollTop = chatBody.scrollHeight;
}

function procesarConsulta(consulta) {
  const consultaLower = consulta.toLowerCase();
  const hist = JSON.parse(localStorage.getItem('historial')||'[]');
  
  if (consultaLower.includes('hola') || consultaLower.includes('hi')) {
    return '¬°Hola! Soy tu asistente virtual. ¬øEn qu√© puedo ayudarte?';
  }
  
  if (consultaLower.includes('estad√≠stica') || consultaLower.includes('estadisticas')) {
    const totalTareas = hist.length;
    if (totalTareas === 0) return 'A√∫n no hay tareas registradas.';
    
    const tareasCompletadas = hist.filter(t => t.signo === '+').length;
    const porcentaje = ((tareasCompletadas / totalTareas) * 100).toFixed(1);
    return `Tienes ${totalTareas} tareas registradas. ${tareasCompletadas} completadas a tiempo (${porcentaje}% de efectividad).`;
  }
  
  if (consultaLower.includes('ayuda')) {
    return 'Puedo ayudarte con:\n‚Ä¢ Informaci√≥n sobre tus tareas\n‚Ä¢ Estad√≠sticas de rendimiento\n‚Ä¢ C√≥mo usar el sistema';
  }
  
  if (consultaLower.includes('tarea actual')) {
    const tareaActiva = JSON.parse(localStorage.getItem('tareaActiva')||'null');
    if (!tareaActiva) return 'No hay tarea en curso.';
    
    const transcurrido = Date.now() - tareaActiva.inicio;
    const restante = (tareaActiva.tiempoEstandar * 3600000) - transcurrido;
    return `Tarea: ${tareaActiva.tarea}\nTiempo transcurrido: ${formatear(transcurrido)}\nRestante: ${formatear(Math.max(0, restante))}`;
  }
  
  return 'Puedo ayudarte con informaci√≥n sobre tus tareas y estad√≠sticas. ¬øEn qu√© necesitas ayuda?';
}

// 3. CONFIRMACI√ìN AL REINICIAR
function reiniciarConConfirmacion(){
  if(!inicioMs) {
    toast('üîÑ No hay tarea activa para reiniciar', '#f39c12');
    return;
  }
  
  if(confirm('¬øEst√°s seguro de que quieres reiniciar la tarea actual? Se perder√° el progreso no guardado.')) {
    reiniciar();
  }
}

// =============================================
// FUNCIONES EXISTENTES (COMPLETAS)
// =============================================

function fillTareasForTipo(tipo){
  const selTarea = document.getElementById('selTarea');
  selTarea.innerHTML = '';
  document.getElementById('inpNombrePersonalizado').value = '';

  if(!tipo){
    selTarea.innerHTML = '<option value="">‚Äî Elige tipo primero ‚Äî</option>';
    document.getElementById('divPersonalizada').style.display = 'none';
    selTarea.style.display = 'block';
    return;
  }

  if(tipo === 'Personalizada'){
    selTarea.style.display = 'none';
    document.getElementById('divPersonalizada').style.display = 'block';
    return;
  }

  document.getElementById('divPersonalizada').style.display = 'none';
  selTarea.style.display = 'block';

  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = '‚Äî Selecciona tarea ‚Äî';
  selTarea.appendChild(placeholder);

  const tareasCombinadas = {};
  const tareasBaseStorage = JSON.parse(localStorage.getItem('tareasBase') || '{}');
  Object.assign(tareasCombinadas, tareasBaseStorage);
  
  const tareasInstrucciones = JSON.parse(localStorage.getItem('tareasInstrucciones') || '{}');
  Object.keys(tareasInstrucciones).forEach(nombre => {
    tareasCombinadas[nombre] = tareasInstrucciones[nombre].tiempo;
  });

  if (Object.keys(tareasCombinadas).length === 0) {
    Object.assign(tareasCombinadas, tareasBase);
  }

  Object.entries(tareasCombinadas).forEach(([nombre, horas])=>{
    const o = document.createElement('option');
    o.value = nombre;
    o.textContent = nombre;
    o.setAttribute('data-tiempo', horas);
    selTarea.appendChild(o);
  });
}

function iniciar(){
  const inpOperacion = document.getElementById('inpOperacion');
  const selTipo = document.getElementById('selTipo');
  const selTarea = document.getElementById('selTarea');
  const inpTiempo = document.getElementById('inpTiempo');
  
  if(!inpOperacion.value.trim()){ toast('Introduce N¬∫ de Operaci√≥n', '#e74c3c'); return; }
  if(!selTipo.value){ toast('Selecciona tipo', '#e74c3c'); return; }
  if(selTipo.value !== 'Personalizada' && !selTarea.value){ toast('Selecciona una tarea', '#e74c3c'); return; }
  const v = parseFloat(inpTiempo.value);
  if(isNaN(v) || v <= 0){ toast('Introduce un tiempo v√°lido', '#e74c3c'); return; }
  if(rafId) return;

  tiempoEstandar = v;
  inicioMs = Date.now();
  alerta10minMostrada = false;
  alerta5minMostrada = false;
  alertaExcedidoMostrada = false;
  modoPrueba = false;

  document.getElementById('excedido').style.display = 'none';
  document.getElementById('progresoFill').style.width = '0%';
  document.getElementById('progresoText').textContent = '0%';
  document.getElementById('progresoFill').classList.remove('excedido');
  document.getElementById('btnStart').disabled = true;
  document.getElementById('btnTerminar').disabled = false;

  guardarTareaActiva();
  if (rafId) cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(loop);
  
  if(selTipo.value !== 'Personalizada' && selTarea.value) {
    setTimeout(() => {
      mostrarInstrucciones();
    }, 300);
  }
  
  toast('‚è± Tarea iniciada', '#2ecc71');
}

function terminar(){
  if(!inicioMs) return;
  if(rafId){ cancelAnimationFrame(rafId); rafId = null; }

  const trans = Date.now() - inicioMs;
  const estimMs = modoPrueba ? (tiempoEstandar * 1000) : (tiempoEstandar * 3600000);
  const restante = estimMs - trans;
  const signo = restante >= 0 ? '+' : '-';
  const diferencia = formatear(Math.abs(restante));
  
  const oper = document.getElementById('inpOperacion').value.trim();
  const tipo = document.getElementById('selTipo').value;
  const tareaNombre = tipo === 'Personalizada' ? 
    (document.getElementById('inpNombrePersonalizado').value||'Sin nombre') : 
    document.getElementById('selTarea').value;

  const tareaObj = {
    operacion: oper,
    tipo: tipo,
    nombre: tareaNombre,
    estimado: tiempoEstandar,
    real: formatear(trans),
    diferencia: diferencia,
    signo: signo,
    fecha: new Date().toISOString()
  };

  const h = JSON.parse(localStorage.getItem('historial')||'[]'); 
  h.push(tareaObj); 
  localStorage.setItem('historial', JSON.stringify(h));
  
  borrarTareaActiva();
  toast('‚úÖ Tarea guardada', '#2ecc71');
  renderTabla();
  
  document.getElementById('selTarea').value = '';
  document.getElementById('inpNombrePersonalizado').value = '';
  document.getElementById('inpTiempo').value = '';
  document.getElementById('minutosConvertidos').textContent = '00:00:00';
  
  document.getElementById('btnStart').disabled = false;
  document.getElementById('btnTerminar').disabled = true;
  
  inicioMs = 0;
  tiempoEstandar = 0;
  alerta10minMostrada = false;
  alerta5minMostrada = false;
  alertaExcedidoMostrada = false;
  
  document.getElementById('cronometro').textContent = 'Restante: 00:00:00';
  document.getElementById('cronometro').style.color = '';
  document.getElementById('excedido').style.display = 'none';
  document.getElementById('progresoFill').style.width = '0%';
  document.getElementById('progresoText').textContent = '0%';
  document.getElementById('progresoFill').classList.remove('excedido');
}

function reiniciar(){
  if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
  inicioMs = 0; 
  tiempoEstandar = 0; 
  alerta10minMostrada = false;
  alerta5minMostrada = false;
  alertaExcedidoMostrada = false;
  modoPrueba = false;
  
  document.getElementById('cronometro').textContent = 'Restante: 00:00:00';
  document.getElementById('cronometro').style.color = '';
  document.getElementById('excedido').style.display = 'none';
  document.getElementById('progresoFill').style.width = '0%';
  document.getElementById('progresoText').textContent = '0%';
  document.getElementById('progresoFill').classList.remove('excedido');
  document.getElementById('btnStart').disabled = false;
  document.getElementById('btnTerminar').disabled = true;
  
  toast('üîÑ Tarea reiniciada', '#f39c12');
}

function actualizarTiempo(){
  if(!inicioMs) return;
  
  const elapsed = Date.now() - inicioMs;
  const estimMs = modoPrueba ? (tiempoEstandar * 1000) : (tiempoEstandar * 3600000);
  const restante = estimMs - elapsed;

  if (restante >= 0) {
    document.getElementById('cronometro').textContent = `Restante: ${formatear(restante)}`;
    document.getElementById('cronometro').style.color = '';
  } else {
    document.getElementById('cronometro').textContent = `Excedido: -${formatear(Math.abs(restante))}`;
    document.getElementById('cronometro').style.color = 'var(--danger)';
  }

  const progreso = Math.min(100, (elapsed / estimMs) * 100);
  document.getElementById('progresoFill').style.width = `${progreso}%`;
  document.getElementById('progresoText').textContent = `${Math.round(progreso)}%`;

  const restanteMs = restante;
  const MINUTO_MS = 60 * 1000;
  const factorEscala = modoPrueba ? 60 : 1;
  const umbral10minAjustado = (10 * MINUTO_MS) / factorEscala;
  const umbral5minAjustado = (5 * MINUTO_MS) / factorEscala;
  
  if(restanteMs <= umbral10minAjustado && restanteMs > umbral5minAjustado && !alerta10minMostrada){
    mostrarAlerta('‚ö†Ô∏è Quedan menos de 10 minutos', 'warning');
    alerta10minMostrada = true;
    guardarTareaActiva();
  }
  
  if(restanteMs <= umbral5minAjustado && restanteMs > 0 && !alerta5minMostrada){
    mostrarAlerta('üö® Quedan menos de 5 minutos', 'danger');
    alerta5minMostrada = true;
    guardarTareaActiva();
  }

  if(restanteMs <= 0 && !alertaExcedidoMostrada){
    document.getElementById('progresoFill').classList.add('excedido');
    document.getElementById('excedido').style.display = 'block';
    document.getElementById('excedido').textContent = `-${formatear(Math.abs(restanteMs))} excedido`;
    mostrarAlerta('‚è∞ Tiempo excedido', 'danger');
    alertaExcedidoMostrada = true;
    guardarTareaActiva();
  }
}

function loop(){
  actualizarTiempo();
  if (Date.now() % 5000 < 16) guardarTareaActiva();
  rafId = requestAnimationFrame(loop);
}

function formatear(ms){
  const t = Math.floor(Math.abs(ms)/1000);
  const h = String(Math.floor(t/3600)).padStart(2,'0');
  const m = String(Math.floor((t%3600)/60)).padStart(2,'0');
  const s = String(t%60).padStart(2,'0');
  return `${h}:${m}:${s}`;
}

function convertDec(h){
  const t = Math.round(h*3600);
  const hh = Math.floor(t/3600), mm = Math.floor((t%3600)/60), ss = t%60;
  return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}

function msFromHHMMSS(hhmmss){
  const parts = (hhmmss||'00:00:00').split(':').map(x=>parseInt(x,10)||0);
  return ((parts[0]*3600)+(parts[1]*60)+parts[2]) * 1000;
}

function toast(msg, color='#2ecc71'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.style.background=color;
  t.style.display='block';
  setTimeout(()=>t.style.display='none',2400);
}

function mostrarAlerta(mensaje, tipo){
  if(silenciado) return;
  
  const alerta = document.createElement('div');
  alerta.textContent = mensaje;
  alerta.style.position = 'fixed';
  alerta.style.top = '20px';
  alerta.style.left = '50%';
  alerta.style.transform = 'translateX(-50%)';
  alerta.style.padding = '15px 20px';
  alerta.style.borderRadius = '10px';
  alerta.style.zIndex = '10000';
  alerta.style.fontWeight = 'bold';
  alerta.style.color = '#fff';
  alerta.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
  
  if(tipo === 'warning'){
    alerta.style.background = 'var(--warning)';
  } else if(tipo === 'danger'){
    alerta.style.background = 'var(--danger)';
  }
  
  document.body.appendChild(alerta);
  
  setTimeout(() => {
    document.body.removeChild(alerta);
  }, 3000);
}

function guardarTareaActiva(){
  if(!inicioMs) return;
  
  const tareaActiva = {
    inicio: inicioMs,
    tiempoEstandar: tiempoEstandar,
    operacion: document.getElementById('inpOperacion').value.trim(),
    tipo: document.getElementById('selTipo').value,
    tarea: document.getElementById('selTipo').value === 'Personalizada' ? 
      (document.getElementById('inpNombrePersonalizado').value||'Sin nombre') : 
      document.getElementById('selTarea').value,
    personalizada: document.getElementById('inpNombrePersonalizado').value||'',
    alerta10minMostrada: alerta10minMostrada,
    alerta5minMostrada: alerta5minMostrada,
    alertaExcedidoMostrada: alertaExcedidoMostrada,
    modoPrueba: modoPrueba
  };
  
  localStorage.setItem('tareaActiva', JSON.stringify(tareaActiva));
}

function leerTareaActiva(){
  try{ return JSON.parse(localStorage.getItem('tareaActiva')||'null'); }catch(e){ return null; }
}

function borrarTareaActiva(){ localStorage.removeItem('tareaActiva'); }

function restaurarTareaActiva(){
  const tareaActiva = leerTareaActiva();
  if(!tareaActiva) return false;
  
  document.getElementById('inpOperacion').value = tareaActiva.operacion || '';
  document.getElementById('selTipo').value = tareaActiva.tipo || '';
  fillTareasForTipo(tareaActiva.tipo);
  
  if(tareaActiva.tipo === 'Personalizada'){
    document.getElementById('inpNombrePersonalizado').value = tareaActiva.personalizada || '';
  } else {
    setTimeout(() => {
      document.getElementById('selTarea').value = tareaActiva.tarea || '';
    }, 100);
  }
  
  document.getElementById('inpTiempo').value = tareaActiva.tiempoEstandar || '';
  document.getElementById('minutosConvertidos').textContent = convertDec(tareaActiva.tiempoEstandar || 0);
  
  inicioMs = tareaActiva.inicio;
  tiempoEstandar = tareaActiva.tiempoEstandar;
  alerta10minMostrada = tareaActiva.alerta10minMostrada || false;
  alerta5minMostrada = tareaActiva.alerta5minMostrada || false;
  alertaExcedidoMostrada = tareaActiva.alertaExcedidoMostrada || false;
  modoPrueba = tareaActiva.modoPrueba || false;
  
  document.getElementById('btnStart').disabled = true;
  document.getElementById('btnTerminar').disabled = false;
  
  if (rafId) cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(loop);
  
  toast('‚è± Tarea activa restaurada', '#f39c12');
  return true;
}

function renderTabla(){
  const tbody = document.querySelector('#tabla tbody');
  tbody.innerHTML = '';
  const hist = JSON.parse(localStorage.getItem('historial')||'[]');
  
  const fechaFiltro = document.getElementById('filtroFecha').value;
  const operacionFiltro = document.getElementById('filtroOperacion').value.trim().toLowerCase();
  let totalMs = 0;
  
  const registrosFiltrados = hist.filter(r => {
    const fechaRegistro = r.fecha.slice(0,10);
    const operacionRegistro = (r.operacion || '').toLowerCase();
    
    if (fechaFiltro && fechaRegistro !== fechaFiltro) return false;
    if (operacionFiltro && !operacionRegistro.includes(operacionFiltro)) return false;
    return true;
  });
  
  registrosFiltrados.forEach(r => {
    const diferenciaMs = msFromHHMMSS(r.diferencia);
    totalMs += (r.signo === '+') ? diferenciaMs : -diferenciaMs;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.operacion || ''}</td>
      <td>${r.tipo || ''}</td>
      <td>${r.nombre || ''}</td>
      <td>${r.estimado || ''}</td>
      <td>${r.real || '00:00:00'}</td>
      <td class="${r.signo === '+' ? 'diff-plus' : 'diff-minus'}">${r.signo}${r.diferencia}</td>
      <td>${new Date(r.fecha).toLocaleString('es-ES')}</td>
    `;
    tbody.appendChild(tr);
  });

  const signoTotal = totalMs >= 0 ? '+' : '-';
  const totalFormateado = formatear(Math.abs(totalMs));
  document.getElementById('floatingTotalValue').textContent = `${signoTotal}${totalFormateado}`;
  document.getElementById('floatingTotalValue').style.color = totalMs >= 0 ? 'var(--success)' : 'var(--danger)';
}

function mostrarEstadisticas() {
  mostrarEstadisticasVisuales();
}

function descargarExcel() {
  const tabla = document.getElementById('tabla');
  let csv = [];
  
  const headers = [];
  for (let i = 0; i < tabla.rows[0].cells.length; i++) {
    headers.push(`"${tabla.rows[0].cells[i].textContent}"`);
  }
  csv.push(headers.join(','));
  
  for (let i = 1; i < tabla.rows.length; i++) {
    const row = [];
    for (let j = 0; j < tabla.rows[i].cells.length; j++) {
      row.push(`"${tabla.rows[i].cells[j].textContent}"`);
    }
    csv.push(row.join(','));
  }
  
  const csvContent = csv.join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `control_tiempo_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
  
  toast('üìä Datos descargados', '#27ae60');
}

function resetearTabla() {
  if(confirm('¬øEst√°s seguro de que quieres borrar todo el historial?')){ 
    localStorage.removeItem('historial'); 
    localStorage.removeItem('tareaActiva');
    renderTabla(); 
    reiniciar();
    toast('üóëÔ∏è Hist√≥rico borrado','#e74c3c'); 
  }
}

function abrirAdministrador() {
  toast('‚öôÔ∏è Abriendo administrador...', '#3498db');
  window.open('admin-tareas.html', '_blank');
}

// FUNCI√ìN PARA MOSTRAR IMAGEN DE HERRAMIENTA EN MODAL (VERSI√ìN AGRANDADA)
function mostrarImagenHerramienta(urlImagen, nombreHerramienta) {
  // Crear modal temporal para mostrar la imagen
  const modal = document.createElement('div');
  modal.style.position = 'fixed';
  modal.style.top = '0';
  modal.style.left = '0';
  modal.style.width = '100%';
  modal.style.height = '100%';
  modal.style.backgroundColor = 'rgba(0,0,0,0.95)';
  modal.style.display = 'flex';
  modal.style.justifyContent = 'center';
  modal.style.alignItems = 'center';
  modal.style.zIndex = '3000';
  modal.style.cursor = 'pointer';
  modal.style.padding = '20px';
  
  modal.innerHTML = `
    <div style="position: relative; max-width: 95%; max-height: 95%; display: flex; flex-direction: column; align-items: center;">
      <img src="${urlImagen}" 
           alt="${nombreHerramienta}" 
           style="max-width: 100%; max-height: 85vh; border-radius: 12px; border: 4px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.5); object-fit: contain;">
      <div style="color: white; text-align: center; margin-top: 15px; font-weight: bold; font-size: 1.2rem; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 8px;">
        ${nombreHerramienta}
      </div>
      <div style="color: #ccc; text-align: center; margin-top: 10px; font-size: 1rem;">
        Haz clic en cualquier lugar para cerrar
      </div>
    </div>
  `;
  
  // Cerrar modal al hacer clic
  modal.addEventListener('click', function() {
    document.body.removeChild(modal);
  });
  
  document.body.appendChild(modal);
  
  // Tambi√©n cerrar con tecla Escape
  const cerrarConEscape = function(e) {
    if (e.key === 'Escape') {
      document.body.removeChild(modal);
      document.removeEventListener('keydown', cerrarConEscape);
    }
  };
  document.addEventListener('keydown', cerrarConEscape);
}

// =============================================
// INICIALIZACI√ìN
// =============================================
window.addEventListener('load', ()=>{
  fillTareasForTipo('');
  
  const hoy = new Date().toISOString().slice(0,10);
  document.getElementById('filtroFecha').value = hoy;
  renderTabla();
  
  inicializarAsistente();
  
  setTimeout(() => {
    if (!restaurarTareaActiva()) {
      console.log('üöÄ Sistema iniciado');
    }
  }, 500);
});

// EVENT LISTENERS
document.getElementById('selTipo').addEventListener('change', function(){
  fillTareasForTipo(this.value);
});

document.getElementById('selTarea').addEventListener('change', function(){
  const t = this.value;
  const tiempo = this.options[this.selectedIndex]?.getAttribute('data-tiempo');
  if(t && tiempo){
    document.getElementById('inpTiempo').value = tiempo;
    document.getElementById('minutosConvertidos').textContent = convertDec(parseFloat(tiempo));
  }
});

document.getElementById('inpTiempo').addEventListener('input', function(){
  const v = parseFloat(this.value);
  document.getElementById('minutosConvertidos').textContent = (!isNaN(v) && v>0) ? convertDec(v) : '00:00:00';
});

document.getElementById('btnStart').addEventListener('click', iniciar);
document.getElementById('btnTerminar').addEventListener('click', terminar);
document.getElementById('btnReset').addEventListener('click', reiniciarConConfirmacion);
document.getElementById('btnSilenciar').addEventListener('click', function(){ 
  silenciado = !silenciado;
  this.textContent = silenciado ? 'üîá Silenciado' : 'üîä Sonidos activados';
  toast(silenciado ? 'üîá Silenciado' : 'üîä Sonidos activados', silenciado ? '#b2bec3' : '#27ae60'); 
});
document.getElementById('btnEstadisticas').addEventListener('click', mostrarEstadisticas);
document.getElementById('btnExportExcel').addEventListener('click', descargarExcel);
document.getElementById('btnResetTabla').addEventListener('click', resetearTabla);
document.getElementById('btnAdmin').addEventListener('click', abrirAdministrador);
document.getElementById('btnInstrucciones').addEventListener('click', mostrarInstrucciones);

// CERRAR MODALES
document.querySelector('#modalEstadisticas .close-modal').addEventListener('click', function() {
  document.getElementById('modalEstadisticas').style.display = 'none';
});

document.getElementById('modalEstadisticas').addEventListener('click', function(e) {
  if (e.target === this) {
    this.style.display = 'none';
  }
});

document.querySelector('#modalInstrucciones .close-modal').addEventListener('click', function() {
  document.getElementById('modalInstrucciones').style.display = 'none';
});

document.getElementById('modalInstrucciones').addEventListener('click', function(e) {
  if (e.target === this) {
    this.style.display = 'none';
  }
});

document.getElementById('filtroFecha').addEventListener('change', renderTabla);
document.getElementById('filtroOperacion').addEventListener('input', renderTabla);
document.getElementById('filtroLimpiar').addEventListener('click', function() {
  document.getElementById('filtroFecha').value = '';
  document.getElementById('filtroOperacion').value = '';
  renderTabla();
  toast('üßπ Filtros limpiados', '#b2bec3');
});

window.addEventListener('beforeunload', function() {
  if (inicioMs) guardarTareaActiva();
});
</script>
</body>
</html>

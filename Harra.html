<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control de Herramientas</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .panel {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn-success { background: #27ae60; }
        .btn-warning { background: #f39c12; }
        .btn-danger { background: #e74c3c; }
        
        input, select {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .tool-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .tool-item:hover {
            background: #f9f9f9;
        }
        
        .status-available { color: #27ae60; font-weight: bold; }
        .status-in-use { color: #f39c12; }
        .status-maintenance { color: #e74c3c; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #27ae60;
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel">
            <h1>üõ†Ô∏è Sistema de Control de Herramientas</h1>
            <div id="status">üîÑ Conectando...</div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div style="font-size: 2em; color: #27ae60;" id="available-count">0</div>
                <div>Disponibles</div>
            </div>
            <div class="stat-card">
                <div style="font-size: 2em; color: #f39c12;" id="in-use-count">0</div>
                <div>En Uso</div>
            </div>
            <div class="stat-card">
                <div style="font-size: 2em; color: #e74c3c;" id="maintenance-count">0</div>
                <div>Mantenimiento</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Columna Izquierda -->
            <div class="panel">
                <h3>üìã Inventario de Herramientas</h3>
                <input type="text" id="search-tool" placeholder="Buscar herramienta...">
                <div id="tools-list" class="loading">Cargando herramientas...</div>
            </div>

            <!-- Columna Derecha -->
            <div class="panel">
                <h3>üë§ Gesti√≥n</h3>
                <input type="text" id="operator-name" placeholder="Nombre del operario">
                
                <!-- Secci√≥n Toma R√°pida -->
                <div id="quick-take-section" style="display: none; background: #e8f4fd; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <h4>Tomar: <span id="selected-tool-name"></span></h4>
                    <select id="quick-station">
                        <option value="">Seleccionar estaci√≥n</option>
                    </select>
                    <button class="btn btn-success" onclick="confirmQuickTake()">‚úÖ Confirmar</button>
                    <button class="btn btn-danger" onclick="cancelQuickTake()">‚ùå Cancelar</button>
                </div>

                <!-- Herramientas del Usuario -->
                <div id="my-tools-section" style="display: none;">
                    <h4>üõ†Ô∏è Mis Herramientas</h4>
                    <select id="my-tools-select">
                        <option value="">Seleccionar herramienta para devolver</option>
                    </select>
                    <button class="btn" onclick="returnTool()">‚Ü©Ô∏è Devolver</button>
                </div>

                <!-- Mantenimiento -->
                <div style="margin-top: 20px;">
                    <h4>üîß Mantenimiento</h4>
                    <select id="maintenance-tool">
                        <option value="">Seleccionar herramienta</option>
                    </select>
                    <button class="btn btn-warning" onclick="sendToMaintenance()">üõ†Ô∏è Enviar a Mantenimiento</button>
                    <button class="btn btn-success" onclick="returnFromMaintenance()">‚úÖ Volver de Mantenimiento</button>
                </div>
            </div>
        </div>

        <!-- Historial -->
        <div class="panel">
            <h3>üìä Historial de Uso</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <select id="filter-tool">
                    <option value="">Todas las herramientas</option>
                </select>
                <select id="filter-operator">
                    <option value="">Todos los operarios</option>
                </select>
                <button class="btn" onclick="refreshHistory()">üîÑ Actualizar</button>
            </div>
            <div id="history-table">
                <div class="loading">Cargando historial...</div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAZ-3ECzy2SyvhlWs9fO65kL5YgrRYSKPA",
            authDomain: "control-herramientas-7d1a3.firebaseapp.com",
            projectId: "control-herramientas-7d1a3",
            storageBucket: "control-herramientas-7d1a3.firebasestorage.app",
            messagingSenderId: "879591007541",
            appId: "1:879591007541:web:1fc3114b99f469691d587c",
            measurementId: "G-K2RE12GLX2"
        };

        // Variables globales
        let db = null;
        let currentTools = [];
        let currentStations = [];
        let currentHistory = [];
        let selectedTool = null;
        let userName = localStorage.getItem('taller_user') || '';

        // Inicializar
        async function init() {
            try {
                // Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Cargar usuario
                if (userName) {
                    document.getElementById('operator-name').value = userName;
                }
                
                // Configurar listener
                setupRealtimeListener();
                
                showNotification('Sistema conectado', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Listener en tiempo real
        function setupRealtimeListener() {
            db.collection('tallerData').doc('herramientas')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        currentTools = data.tools || getDefaultTools();
                        currentStations = data.stations || getDefaultStations();
                        currentHistory = data.history || [];
                        
                        updateUI();
                    } else {
                        createInitialData();
                    }
                }, (error) => {
                    console.error('Error listener:', error);
                    document.getElementById('status').innerHTML = '‚ùå Error de conexi√≥n';
                });
        }

        // Datos por defecto
        function getDefaultTools() {
            return [
                { id: 1, name: "Llave Dinamom√©trica 6Nm", serial: "LD6N-001", status: "available", operator: "", station: "" },
                { id: 2, name: "Llave Dinamom√©trica 6Nm", serial: "LD6N-002", status: "available", operator: "", station: "" },
                { id: 3, name: "Llave Dinamom√©trica 6Nm", serial: "LD6N-003", status: "available", operator: "", station: "" },
                { id: 4, name: "Llave Dinamom√©trica 6Nm", serial: "LD6N-004", status: "available", operator: "", station: "" },
                { id: 5, name: "Llave Dinamom√©trica 6Nm", serial: "LD6N-005", status: "available", operator: "", station: "" },
                { id: 6, name: "Destornillador Plano", serial: "DPL-001", status: "available", operator: "", station: "" },
                { id: 7, name: "Taladro El√©ctrico", serial: "TEL-001", status: "available", operator: "", station: "" }
            ];
        }

        function getDefaultStations() {
            return [
                { id: "estacion-1", name: "Estaci√≥n 1 - Ensamblaje" },
                { id: "estacion-2", name: "Estaci√≥n 2 - Soldadura" },
                { id: "estacion-3", name: "Estaci√≥n 3 - Pintura" }
            ];
        }

        async function createInitialData() {
            const data = {
                tools: getDefaultTools(),
                stations: getDefaultStations(),
                history: [],
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('tallerData').doc('herramientas').set(data);
        }

        // Actualizar interfaz
        function updateUI() {
            updateStats();
            renderTools();
            updateMyTools();
            updateMaintenanceSelect();
            updateHistory();
            updateFilters();
            populateStations();
            
            document.getElementById('status').innerHTML = '‚úÖ Conectado';
        }

        function updateStats() {
            const available = currentTools.filter(t => t.status === 'available').length;
            const inUse = currentTools.filter(t => t.status === 'in-use').length;
            const maintenance = currentTools.filter(t => t.status === 'maintenance').length;
            
            document.getElementById('available-count').textContent = available;
            document.getElementById('in-use-count').textContent = inUse;
            document.getElementById('maintenance-count').textContent = maintenance;
        }

        function renderTools() {
            const search = document.getElementById('search-tool').value.toLowerCase();
            const toolsList = document.getElementById('tools-list');
            
            let html = '';
            currentTools.forEach(tool => {
                if (search && !tool.name.toLowerCase().includes(search) && !tool.serial.toLowerCase().includes(search)) {
                    return;
                }
                
                let statusClass = 'status-available';
                let statusText = 'Disponible';
                
                if (tool.status === 'in-use') {
                    statusClass = 'status-in-use';
                    statusText = `En uso por ${tool.operator}`;
                } else if (tool.status === 'maintenance') {
                    statusClass = 'status-maintenance';
                    statusText = 'En mantenimiento';
                }
                
                html += `
                    <div class="tool-item" onclick="quickTakeTool(${tool.id})">
                        <strong>${tool.name}</strong> 
                        <small>(${tool.serial})</small>
                        <div class="${statusClass}">${statusText}</div>
                    </div>
                `;
            });
            
            toolsList.innerHTML = html || '<div>No se encontraron herramientas</div>';
        }

        // Toma r√°pida
        function quickTakeTool(toolId) {
            userName = document.getElementById('operator-name').value.trim();
            if (!userName) {
                showNotification('Primero ingresa tu nombre', 'warning');
                document.getElementById('operator-name').focus();
                return;
            }
            
            localStorage.setItem('taller_user', userName);
            
            const tool = currentTools.find(t => t.id === toolId);
            if (!tool || tool.status !== 'available') {
                showNotification('Herramienta no disponible', 'warning');
                return;
            }
            
            selectedTool = tool;
            document.getElementById('selected-tool-name').textContent = `${tool.name} (${tool.serial})`;
            document.getElementById('quick-take-section').style.display = 'block';
        }

        function cancelQuickTake() {
            selectedTool = null;
            document.getElementById('quick-take-section').style.display = 'none';
        }

        async function confirmQuickTake() {
            if (!selectedTool) return;
            
            const station = document.getElementById('quick-station').value;
            if (!station) {
                showNotification('Selecciona una estaci√≥n', 'warning');
                return;
            }
            
            // Actualizar herramienta
            const updatedTools = currentTools.map(tool => 
                tool.id === selectedTool.id 
                    ? { ...tool, status: 'in-use', operator: userName, station: station }
                    : tool
            );
            
            // Agregar al historial
            const newHistory = [{
                tool: selectedTool.name,
                serial: selectedTool.serial,
                action: 'tomada',
                operator: userName,
                station: getStationName(station),
                time: new Date().toISOString()
            }, ...currentHistory];
            
            // Guardar
            await saveData(updatedTools, newHistory);
            
            showNotification(`Herramienta ${selectedTool.serial} tomada`, 'success');
            cancelQuickTake();
        }

        // Devolver herramienta
        function updateMyTools() {
            userName = document.getElementById('operator-name').value.trim();
            const myToolsSection = document.getElementById('my-tools-section');
            const myToolsSelect = document.getElementById('my-tools-select');
            
            if (!userName) {
                myToolsSection.style.display = 'none';
                return;
            }
            
            const myTools = currentTools.filter(tool => 
                tool.status === 'in-use' && tool.operator === userName
            );
            
            if (myTools.length === 0) {
                myToolsSection.style.display = 'none';
                return;
            }
            
            myToolsSection.style.display = 'block';
            myToolsSelect.innerHTML = '<option value="">Seleccionar herramienta para devolver</option>';
            myTools.forEach(tool => {
                const option = document.createElement('option');
                option.value = tool.id;
                option.textContent = `${tool.name} (${tool.serial})`;
                myToolsSelect.appendChild(option);
            });
        }

        async function returnTool() {
            const toolId = parseInt(document.getElementById('my-tools-select').value);
            if (!toolId) {
                showNotification('Selecciona una herramienta', 'warning');
                return;
            }
            
            const tool = currentTools.find(t => t.id === toolId);
            if (!tool) return;
            
            // Actualizar herramienta
            const updatedTools = currentTools.map(t => 
                t.id === toolId 
                    ? { ...t, status: 'available', operator: '', station: '' }
                    : t
            );
            
            // Agregar al historial
            const newHistory = [{
                tool: tool.name,
                serial: tool.serial,
                action: 'devuelta',
                operator: userName,
                station: 'Almac√©n',
                time: new Date().toISOString()
            }, ...currentHistory];
            
            await saveData(updatedTools, newHistory);
            showNotification(`Herramienta ${tool.serial} devuelta`, 'success');
        }

        // Mantenimiento
        function updateMaintenanceSelect() {
            const select = document.getElementById('maintenance-tool');
            select.innerHTML = '<option value="">Seleccionar herramienta</option>';
            
            currentTools.forEach(tool => {
                const option = document.createElement('option');
                option.value = tool.id;
                option.textContent = `${tool.name} (${tool.serial}) - ${tool.status}`;
                select.appendChild(option);
            });
        }

        async function sendToMaintenance() {
            const toolId = parseInt(document.getElementById('maintenance-tool').value);
            if (!toolId) {
                showNotification('Selecciona una herramienta', 'warning');
                return;
            }
            
            const tool = currentTools.find(t => t.id === toolId);
            if (!tool) return;
            
            const updatedTools = currentTools.map(t => 
                t.id === toolId 
                    ? { ...t, status: 'maintenance', operator: '', station: '' }
                    : t
            );
            
            const newHistory = [{
                tool: tool.name,
                serial: tool.serial,
                action: 'mantenimiento',
                operator: userName,
                station: 'Taller Mantenimiento',
                time: new Date().toISOString()
            }, ...currentHistory];
            
            await saveData(updatedTools, newHistory);
            showNotification(`Herramienta ${tool.serial} en mantenimiento`, 'warning');
        }

        async function returnFromMaintenance() {
            const toolId = parseInt(document.getElementById('maintenance-tool').value);
            if (!toolId) {
                showNotification('Selecciona una herramienta', 'warning');
                return;
            }
            
            const tool = currentTools.find(t => t.id === toolId);
            if (!tool || tool.status !== 'maintenance') {
                showNotification('La herramienta no est√° en mantenimiento', 'warning');
                return;
            }
            
            const updatedTools = currentTools.map(t => 
                t.id === toolId 
                    ? { ...t, status: 'available' }
                    : t
            );
            
            const newHistory = [{
                tool: tool.name,
                serial: tool.serial,
                action: 'disponible',
                operator: userName,
                station: 'Almac√©n',
                time: new Date().toISOString()
            }, ...currentHistory];
            
            await saveData(updatedTools, newHistory);
            showNotification(`Herramienta ${tool.serial} disponible`, 'success');
        }

        // Historial
        function updateHistory() {
            const toolFilter = document.getElementById('filter-tool').value;
            const operatorFilter = document.getElementById('filter-operator').value;
            
            let filteredHistory = currentHistory;
            
            if (toolFilter) {
                filteredHistory = filteredHistory.filter(item => item.tool === toolFilter);
            }
            if (operatorFilter) {
                filteredHistory = filteredHistory.filter(item => item.operator === operatorFilter);
            }
            
            let html = '<table><tr><th>Fecha/Hora</th><th>Herramienta</th><th>Serie</th><th>Operario</th><th>Acci√≥n</th><th>Estaci√≥n</th></tr>';
            
            if (filteredHistory.length === 0) {
                html += '<tr><td colspan="6" style="text-align: center;">No hay registros</td></tr>';
            } else {
                filteredHistory.slice(0, 20).forEach(item => {
                    html += `
                        <tr>
                            <td>${formatDateTime(item.time)}</td>
                            <td>${item.tool}</td>
                            <td>${item.serial}</td>
                            <td>${item.operator}</td>
                            <td>${item.action}</td>
                            <td>${item.station}</td>
                        </tr>
                    `;
                });
            }
            
            html += '</table>';
            document.getElementById('history-table').innerHTML = html;
        }

        function updateFilters() {
            // Herramientas √∫nicas
            const tools = [...new Set(currentHistory.map(item => item.tool))];
            const toolFilter = document.getElementById('filter-tool');
            toolFilter.innerHTML = '<option value="">Todas las herramientas</option>';
            tools.forEach(tool => {
                const option = document.createElement('option');
                option.value = tool;
                option.textContent = tool;
                toolFilter.appendChild(option);
            });
            
            // Operarios √∫nicos
            const operators = [...new Set(currentHistory.map(item => item.operator))];
            const operatorFilter = document.getElementById('filter-operator');
            operatorFilter.innerHTML = '<option value="">Todos los operarios</option>';
            operators.forEach(operator => {
                const option = document.createElement('option');
                option.value = operator;
                option.textContent = operator;
                operatorFilter.appendChild(option);
            });
        }

        function refreshHistory() {
            updateHistory();
        }

        // Utilidades
        function populateStations() {
            const select = document.getElementById('quick-station');
            select.innerHTML = '<option value="">Seleccionar estaci√≥n</option>';
            currentStations.forEach(station => {
                const option = document.createElement('option');
                option.value = station.id;
                option.textContent = station.name;
                select.appendChild(option);
            });
        }

        function getStationName(stationId) {
            const station = currentStations.find(s => s.id === stationId);
            return station ? station.name : 'Desconocida';
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('es-ES');
        }

        async function saveData(tools, history) {
            try {
                await db.collection('tallerData').doc('herramientas').update({
                    tools: tools,
                    history: history,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error guardando:', error);
                showNotification('Error guardando datos', 'error');
            }
        }

        function showNotification(message, type) {
            // Crear notificaci√≥n simple
            const div = document.createElement('div');
            div.className = 'notification';
            div.style.background = type === 'success' ? '#27ae60' : type === 'warning' ? '#f39c12' : '#e74c3c';
            div.textContent = message;
            document.body.appendChild(div);
            
            setTimeout(() => {
                document.body.removeChild(div);
            }, 3000);
        }

        // Event listeners
        document.getElementById('operator-name').addEventListener('input', function() {
            userName = this.value.trim();
            localStorage.setItem('taller_user', userName);
            updateMyTools();
        });

        document.getElementById('search-tool').addEventListener('input', renderTools);

        // Inicializar
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

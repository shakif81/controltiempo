
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control de Herramientas - Sincronizado</title>
    <!-- Tailwind CSS (usado para un diseño responsive y moderno) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos de Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2c3e50',
                        secondary: '#3498db',
                        success: '#27ae60',
                        warning: '#f39c12',
                        danger: '#e74c3c',
                        light: '#ecf0f1',
                        dark: '#34495e',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        .notification {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateY(100px);
            opacity: 0;
            z-index: 1000;
        }
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .scroll-list {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

    <!-- Notificación -->
    <div id="notification" class="notification fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white font-semibold flex items-center space-x-2"></div>
    
    <div class="container mx-auto p-4 md:p-8 flex-grow">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-primary mb-2">Control de Herramientas Taller</h1>
            <p class="text-dark">Sincronización en tiempo real con Firebase Realtime Database</p>
            <div id="user-info" class="mt-2 text-sm text-gray-600">
                <span id="current-user-id" class="font-mono bg-gray-200 px-2 py-1 rounded">Cargando ID...</span>
                <span id="user-count" class="ml-4 font-bold text-secondary"><i class="fas fa-users"></i> 0 Operarios Conectados</span>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Panel de Tareas -->
            <div class="lg:col-span-1 space-y-8">
                
                <!-- Tomar Herramienta -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold text-dark mb-4 border-b pb-2"><i class="fas fa-hand-rock text-secondary mr-2"></i> Tomar Herramienta</h2>
                    <form id="take-tool-form" class="space-y-4">
                        <div>
                            <label for="take-tool-select" class="block text-sm font-medium text-gray-700 mb-1">Herramienta:</label>
                            <select id="take-tool-select" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary">
                                <option value="" disabled selected>Selecciona una herramienta</option>
                            </select>
                        </div>
                        <div>
                            <label for="take-operator" class="block text-sm font-medium text-gray-700 mb-1">Operario:</label>
                            <input type="text" id="take-operator" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary" placeholder="Introduce tu nombre/ID">
                        </div>
                        <div>
                            <label for="take-station" class="block text-sm font-medium text-gray-700 mb-1">Estación de Trabajo:</label>
                            <select id="take-station" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary">
                                <option value="" disabled selected>Selecciona estación</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-secondary text-white p-3 rounded-lg font-bold hover:bg-blue-600 transition duration-200 shadow-md">
                            <i class="fas fa-dolly-flatbed mr-2"></i> Confirmar Retiro
                        </button>
                    </form>
                </div>

                <!-- Devolver Herramienta -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold text-dark mb-4 border-b pb-2"><i class="fas fa-undo-alt text-success mr-2"></i> Devolver Herramienta</h2>
                    <form id="return-tool-form" class="space-y-4">
                        <div>
                            <label for="return-tool-select" class="block text-sm font-medium text-gray-700 mb-1">Herramienta a devolver:</label>
                            <select id="return-tool-select" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-success focus:border-success">
                                <option value="" disabled selected>Selecciona herramienta en uso</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-success text-white p-3 rounded-lg font-bold hover:bg-green-600 transition duration-200 shadow-md">
                            <i class="fas fa-warehouse mr-2"></i> Confirmar Devolución
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Panel Central: Estado de Herramientas -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-dark mb-4 border-b pb-2"><i class="fas fa-tools text-primary mr-2"></i> Estado del Inventario</h2>
                <div id="tools-status" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <div class="col-span-full text-center p-8 text-gray-500" id="loading-message">
                        <i class="fas fa-sync fa-spin mr-2"></i> Cargando datos de la base de datos...
                    </div>
                </div>
            </div>

            <!-- Historial (Móvil) -->
            <div class="lg:hidden mt-8 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-dark mb-4 border-b pb-2"><i class="fas fa-history text-gray-500 mr-2"></i> Historial de Movimientos</h2>
                <div id="history-list-mobile" class="scroll-list space-y-2 text-sm">
                    <!-- Contenido del historial -->
                </div>
            </div>

        </main>
        
        <!-- Historial (Desktop) -->
        <div class="mt-8 bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden lg:block">
            <h2 class="text-2xl font-semibold text-dark mb-4 border-b pb-2"><i class="fas fa-history text-gray-500 mr-2"></i> Historial de Movimientos</h2>
            <div id="history-list" class="scroll-list space-y-2 text-sm">
                <!-- Contenido del historial -->
            </div>
        </div>

    </div>

    <!-- Script de Inicialización y Lógica de la Aplicación -->
    <script type="module">
        // --- 1. CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE ---
        
        // **CORRECCIÓN:** Usamos las variables globales de Canvas para la configuración y autenticación.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'taller-default'; 

        // Función para sanear la clave eliminando caracteres no permitidos en rutas de Realtime Database
        const sanitizeKey = (key) => {
            return key.replace(/[.#$[\]/-]/g, '_');
        };
        
        // FIX DE RTDB: Verificación para asegurarse que databaseURL está configurado
        if (firebaseConfig.projectId && !firebaseConfig.databaseURL) {
            firebaseConfig.databaseURL = `https://${firebaseConfig.projectId}.firebaseio.com`;
        }
        
        // Importaciones de Firebase (Realtime Database y Auth)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        
        // Inicializar la aplicación Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // Referencia principal para los datos públicos del taller
        // Usamos la estructura de ruta obligatoria para datos públicos en Canvas
        const DB_PATH = `artifacts/${sanitizeKey(appId)}/public/data/taller_tools`;
        const USERS_PATH = `artifacts/${sanitizeKey(appId)}/public/data/online_users`;
        
        let dbRef = null;
        let usersRef = null;
        let currentUserId = null;


        // --- 2. CLASE PRINCIPAL DEL SISTEMA DE TALLER ---

        class TallerSystem {
            constructor(dbRef, usersRef, currentUserId) {
                this.dbRef = dbRef;
                this.usersRef = usersRef;
                this.currentUserId = currentUserId;

                this.tools = [];
                this.stations = [];
                this.history = [];
                this.currentUser = ''; // Nombre del operario actual
                this.userPresenceRef = null; // Referencia de presencia del usuario

                this.init();
            }

            getDefaultTools() {
                return [
                    { name: 'Llave Inglesa 10mm', id: 'L-10', status: 'disponible', lastOperator: null, lastStation: null, lastTime: null },
                    { name: 'Destornillador Philips P2', id: 'D-P2', status: 'disponible', lastOperator: null, lastStation: null, lastTime: null },
                    { name: 'Martillo de Bola 500g', id: 'M-500', status: 'disponible', lastOperator: null, lastStation: null, lastTime: null },
                    { name: 'Taladro de Columna', id: 'T-COL', status: 'disponible', lastOperator: null, lastStation: null, lastTime: null },
                ];
            }

            getDefaultStations() {
                return ['Estación 1', 'Estación 2', 'Montaje A', 'Control Calidad'];
            }

            // --- Inicialización y Escucha (Reemplazo de localStorage.loadData y listener) ---

            init() {
                this.setupFirebaseListener();
                this.setupEventListeners();
                this.setupUserTracking();
            }

            setupFirebaseListener() {
                // Escucha en tiempo real (Realtime Database)
                onValue(this.dbRef, (snapshot) => {
                    const data = snapshot.val();
                    document.getElementById('loading-message')?.remove(); // Eliminar mensaje de carga

                    if (data) {
                        // Carga los datos de la base de datos
                        this.tools = data.tools || this.getDefaultTools();
                        this.stations = data.stations || this.getDefaultStations();
                        this.history = data.history || [];
                        this.lastUpdate = data.lastUpdate;

                        this.renderAll(); // Vuelve a dibujar la interfaz con los datos nuevos
                        this.showNotification(`Datos sincronizados: última actualización ${new Date(this.lastUpdate).toLocaleTimeString()}`, 'success');
                    } else {
                        // Si la base de datos está vacía, inicializa los datos por primera vez
                        this.initializeDefaultData();
                    }
                }, (error) => {
                    console.error("Error al leer de Firebase:", error);
                    this.showNotification('Error de conexión con la base de datos', 'error');
                });
            }

            initializeDefaultData() {
                this.tools = this.getDefaultTools();
                this.stations = this.getDefaultStations();
                this.history = [];

                // Guardar los datos por defecto en Firebase
                this.saveData();
            }

            // --- Guardar Datos (Usa set() para guardar en RTDB) ---
            
            saveData() {
                const dataToSave = {
                    tools: this.tools,
                    stations: this.stations,
                    history: this.history,
                    lastUpdate: new Date().toISOString(),
                };

                // Usa set() para guardar los datos en el nodo principal
                set(this.dbRef, dataToSave)
                    .then(() => {
                        console.log('Datos guardados exitosamente en Firebase');
                        // El listener de onValue se encargará de renderAll()
                    })
                    .catch(error => {
                        console.error('Error al guardar en Firebase:', error);
                        this.showNotification('Error de sincronización con la nube', 'error');
                    });
            }
            
            // --- Sincronización de Presencia de Usuarios ---

            setupUserTracking() {
                this.userPresenceRef = ref(db, `${USERS_PATH}/${this.currentUserId}`);
                
                // 1. Establecer la presencia al conectar (online)
                set(this.userPresenceRef, { 
                    online: true, 
                    timestamp: new Date().toISOString(),
                    lastAction: 'Conectado'
                });

                // 2. Usar onDisconnect para remover la presencia al desconectar
                onDisconnect(this.userPresenceRef).remove();

                // 3. Escuchar la lista de usuarios para actualizar el contador
                onValue(this.usersRef, (snapshot) => {
                    const users = snapshot.val();
                    const count = users ? Object.keys(users).length : 0;
                    this.updateUserCount(count);
                });
            }

            updateUserCount(count) {
                const countElement = document.getElementById('user-count');
                if (countElement) {
                    countElement.innerHTML = `<i class="fas fa-users"></i> ${count || 0} Operarios Conectados`;
                }
            }
            
            // --- Lógica del Taller (Usa this.saveData()) ---

            takeTool(toolId, operator, station) {
                const toolIndex = this.tools.findIndex(t => t.id === toolId);

                if (toolIndex === -1 || this.tools[toolIndex].status !== 'disponible') {
                    this.showNotification('Error: Herramienta no disponible o ID incorrecto.', 'danger');
                    return;
                }

                const tool = this.tools[toolIndex];
                const now = new Date();

                // 1. Actualizar estado de la herramienta
                tool.status = 'en-uso';
                tool.lastOperator = operator;
                tool.lastStation = station;
                tool.lastTime = now.toISOString();

                // 2. Agregar al historial
                this.history.unshift({
                    tool: tool.name,
                    toolId: tool.id,
                    action: 'retirada',
                    operator: operator,
                    station: station,
                    time: now.toISOString()
                });
                
                // 3. Guardar y sincronizar con Firebase
                this.saveData();

                // 4. Actualizar presencia
                if (this.userPresenceRef) {
                     set(this.userPresenceRef, { 
                        online: true, 
                        timestamp: new Date().toISOString(),
                        lastAction: `Retiró ${tool.name}`
                    });
                }
                
                this.showNotification(`Herramienta "${tool.name}" retirada por ${operator} hacia ${station}`, 'success');
            }

            returnTool(toolId, operator) {
                const toolIndex = this.tools.findIndex(t => t.id === toolId);
                
                if (toolIndex === -1 || this.tools[toolIndex].status !== 'en-uso') {
                    this.showNotification('Error: Herramienta no está actualmente en uso o ID incorrecto.', 'danger');
                    return;
                }

                const tool = this.tools[toolIndex];
                const now = new Date();

                // 1. Actualizar estado de la herramienta
                tool.status = 'disponible';
                tool.lastStation = 'Almacén';

                // 2. Agregar al historial
                this.history.unshift({
                    tool: tool.name,
                    toolId: tool.id,
                    action: 'devuelta',
                    operator: operator,
                    station: 'Almacén',
                    time: now.toISOString()
                });
                
                // 3. Guardar y sincronizar con Firebase
                this.saveData();

                // 4. Actualizar presencia
                if (this.userPresenceRef) {
                     set(this.userPresenceRef, { 
                        online: true, 
                        timestamp: new Date().toISOString(),
                        lastAction: `Devolvió ${tool.name}`
                    });
                }

                this.showNotification(`Herramienta "${tool.name}" devuelta correctamente al Almacén`, 'success');
            }
            
            // --- Métodos de Renderizado y UI ---

            renderAll() {
                this.renderToolsStatus();
                this.renderForms();
                this.renderHistory();
            }

            renderToolsStatus() {
                const container = document.getElementById('tools-status');
                if (!container) return;

                container.innerHTML = this.tools.map(tool => {
                    const statusClass = tool.status === 'disponible' ? 'bg-success/20 text-success border-success' : 'bg-warning/20 text-warning border-warning';
                    const icon = tool.status === 'disponible' ? 'fa-check' : 'fa-hand-holding';
                    
                    let infoDetail = '';
                    if (tool.status === 'en-uso') {
                        infoDetail = `
                            <p class="text-xs font-semibold mt-2">En uso por:</p>
                            <p class="text-sm font-bold">${tool.lastOperator || 'N/A'}</p>
                            <p class="text-xs mt-1">Ubicación: ${tool.lastStation || 'N/A'}</p>
                            <p class="text-xs text-gray-500">${tool.lastTime ? this.timeSince(new Date(tool.lastTime)) : ''}</p>
                        `;
                    } else {
                        infoDetail = `
                            <p class="text-xs mt-1 text-gray-500">Último uso: ${tool.lastOperator || 'N/A'}</p>
                            <p class="text-xs text-gray-500">${tool.lastTime ? this.timeSince(new Date(tool.lastTime)) : ''}</p>
                        `;
                    }

                    return `
                        <div class="p-4 rounded-xl shadow-md transition duration-150 hover:shadow-lg ${statusClass} border-l-4">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-bold">${tool.name}</h3>
                                <i class="fas ${icon} text-xl"></i>
                            </div>
                            <p class="text-sm text-gray-700 mt-1">ID: ${tool.id}</p>
                            <p class="font-bold text-sm uppercase mt-2">${tool.status.replace('-', ' ')}</p>
                            ${infoDetail}
                        </div>
                    `;
                }).join('');
            }

            renderForms() {
                const takeToolSelect = document.getElementById('take-tool-select');
                const returnToolSelect = document.getElementById('return-tool-select');
                const takeStationSelect = document.getElementById('take-station');
                
                if (takeToolSelect) {
                    takeToolSelect.innerHTML = '<option value="" disabled selected>Selecciona una herramienta</option>';
                    this.tools.filter(t => t.status === 'disponible').forEach(tool => {
                        const option = document.createElement('option');
                        option.value = tool.id;
                        option.textContent = `${tool.name} (${tool.id})`;
                        takeToolSelect.appendChild(option);
                    });
                }

                if (returnToolSelect) {
                    returnToolSelect.innerHTML = '<option value="" disabled selected>Selecciona herramienta en uso</option>';
                    this.tools.filter(t => t.status === 'en-uso').forEach(tool => {
                        const option = document.createElement('option');
                        option.value = tool.id;
                        option.textContent = `${tool.name} (${tool.lastOperator} en ${tool.lastStation})`;
                        returnToolSelect.appendChild(option);
                    });
                }
                
                if (takeStationSelect && takeStationSelect.options.length <= 1) {
                    this.stations.forEach(station => {
                        const option = document.createElement('option');
                        option.value = station;
                        option.textContent = station;
                        takeStationSelect.appendChild(option);
                    });
                }
            }

            renderHistory() {
                const historyList = document.getElementById('history-list');
                const historyListMobile = document.getElementById('history-list-mobile');
                
                [historyList, historyListMobile].forEach(container => {
                    if (!container) return;
                    
                    container.innerHTML = this.history.slice(0, 20).map(item => { // Mostrar solo las últimas 20 entradas
                        const actionClass = item.action === 'retirada' ? 'bg-warning/10 text-warning' : 'bg-success/10 text-success';
                        const actionIcon = item.action === 'retirada' ? 'fa-arrow-right' : 'fa-arrow-left';
                        const time = new Date(item.time).toLocaleString();
                        
                        return `
                            <div class="p-3 rounded-lg flex items-center ${actionClass} border border-gray-200">
                                <i class="fas ${actionIcon} mr-3 font-bold"></i>
                                <div>
                                    <p>
                                        <span class="font-bold">${item.operator}</span> 
                                        ha ${item.action} la herramienta 
                                        <span class="font-mono">${item.tool}</span> 
                                        ${item.action === 'retirada' ? `hacia ${item.station}` : `al ${item.station}`}.
                                    </p>
                                    <p class="text-xs text-gray-500 mt-1">${time}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                });
            }
            
            // --- Manejo de Eventos y Notificaciones ---

            setupEventListeners() {
                document.getElementById('take-tool-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const toolId = document.getElementById('take-tool-select').value;
                    const operator = document.getElementById('take-operator').value.trim();
                    const station = document.getElementById('take-station').value;
                    
                    if (toolId && operator && station) {
                        this.takeTool(toolId, operator, station);
                        document.getElementById('take-tool-select').value = '';
                        // Dejamos el operario en el campo para uso rápido
                    }
                });

                document.getElementById('return-tool-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const returnToolSelect = document.getElementById('return-tool-select');
                    const toolId = returnToolSelect.value;
                    
                    // Reutilizamos el último nombre de operario conocido (si está disponible) o pedimos el de la toma
                    const operator = document.getElementById('take-operator').value.trim() || 'Operario de Devolución'; 
                    
                    if (toolId) {
                        this.returnTool(toolId, operator);
                        returnToolSelect.value = '';
                    }
                });
            }

            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                if (!notification) return;

                const icon = type === 'success' ? 'fas fa-check-circle' : 
                             type === 'warning' ? 'fas fa-exclamation-triangle' : 
                             'fas fa-exclamation-circle';
                const bgColor = type === 'success' ? 'bg-success' : 
                                type === 'warning' ? 'bg-warning' : 
                                'bg-danger';

                notification.innerHTML = `<i class="${icon}"></i> ${message}`;
                notification.className = `notification fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white font-semibold flex items-center space-x-2 ${bgColor} show`;

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 4000);
            }
            
            timeSince(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                
                if (interval > 1) return Math.floor(interval) + " años";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " meses";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " días";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " horas";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " minutos";
                return Math.floor(seconds) + " segundos";
            }
        }

        // --- 3. PROCESO DE AUTENTICACIÓN E INICIALIZACIÓN ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // El usuario está autenticado (o anónimamente)
                currentUserId = user.uid;
                
                // Mostrar ID del usuario en la UI
                const userIdElement = document.getElementById('current-user-id');
                if (userIdElement) {
                    userIdElement.textContent = `Operario ID (DB): ${currentUserId}`;
                }
                
                // Referencia específica del taller y de usuarios online
                dbRef = ref(db, DB_PATH);
                usersRef = ref(db, USERS_PATH);

                // Inicializar el sistema de taller con las referencias de Firebase
                if (!window.tallerSystem) {
                    window.tallerSystem = new TallerSystem(dbRef, usersRef, currentUserId);
                }

            } else {
                // Si no hay usuario, intentar iniciar sesión.
                try {
                    if (initialAuthToken) {
                        // Usar el token de autenticación personalizado de Canvas
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        // Si no hay token, usar inicio de sesión anónimo (por si se ejecuta externamente)
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    // El error original indicaba claves incorrectas; ahora debería autenticarse.
                    console.error("Error de autenticación:", error);
                    console.error("No se pudo conectar a la base de datos. Verifica que las variables globales de Canvas o tu configuración de Firebase sean correctas.");
                }
            }
        });
        
    </script>
</body>
</html>
